                    Chat Live
                </button>
                
                <button onclick="openDCASwap()" class="flex items-center gap-2 px-4 py-3 bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700 rounded-lg font-semibold transition-all">
                    <span>üîÑ</span>
                    DCA/Swap
                    <span>‚Üó</span><!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bot Trading Multi-Crypto Pro - Fixed</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        body {
            background: linear-gradient(to bottom right, #0f172a, #581c87, #0f172a);
            min-height: 100vh;
        }
        .animate-spin {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }
    </style>
</head>
<body class="text-white p-4 md:p-6">
    <div class="max-w-7xl mx-auto">
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-8">
            <div>
                <h1 class="text-3xl md:text-4xl font-bold bg-gradient-to-r from-yellow-400 to-orange-500 bg-clip-text text-transparent">
                    Bot Trading Multi-Crypto Pro
                </h1>
                <p class="text-gray-400 mt-2">Trading r√©el BSC ‚Ä¢ Prix temps r√©el ‚Ä¢ Trading automatique 24/7</p>
            </div>
            
            <div class="flex gap-3">
                <button onclick="openChat()" class="flex items-center gap-2 px-4 py-3 bg-gradient-to-r from-green-500 to-teal-600 hover:from-green-600 hover:to-teal-700 rounded-lg font-semibold transition-all">
                    <span>üí¨</span>
                    Chat Live
                </button>
                
                <button onclick="openDCASwap()" class="flex items-center gap-2 px-4 py-3 bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700 rounded-lg font-semibold transition-all">
                    <span>üîÑ</span>
                    DCA/Swap
                    <span>‚Üó</span>
                </button>
                
                <button onclick="connectWallet()" id="connectBtn" class="flex items-center gap-2 px-6 py-3 rounded-lg font-semibold transition-all bg-gradient-to-r from-yellow-400 to-orange-500 hover:from-yellow-500 hover:to-orange-600">
                    <span>üëõ</span>
                    <span id="walletText">Connecter MetaMask</span>
                </button>
            </div>
        </div>

        <div id="subscriptionSection" class="bg-gradient-to-r from-purple-500/20 to-pink-500/20 border-2 border-purple-500 rounded-xl p-6 mb-6 hidden">
            <h3 class="text-xl font-bold mb-4 flex items-center gap-2">
                <span>üíé</span>
                Abonnement Bot Trading Pro
            </h3>
            
            <div id="freeTrialInfo" class="bg-green-500/20 border border-green-500 rounded-lg p-4 mb-4">
                <p class="text-green-300 font-bold mb-2">üéÅ OFFRE DE LANCEMENT</p>
                <p class="text-sm text-green-200">
                    ‚úÖ 2 jours GRATUITS pour tester le bot<br>
                    ‚úÖ Toutes les fonctionnalit√©s incluses<br>
                    ‚úÖ Trading r√©el + Simulation<br>
                    <span id="trialDaysRemaining" class="font-bold text-green-400"></span>
                </p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                <div class="bg-slate-700/50 border-2 border-slate-600 rounded-lg p-4 hover:border-purple-400 transition-all cursor-pointer" onclick="selectPlan(1, 1)">
                    <div class="text-center">
                        <p class="text-2xl font-bold text-purple-400">1 USDT</p>
                        <p class="text-sm text-gray-400 mt-1">1 jour</p>
                        <p class="text-xs text-gray-500 mt-2">Essai simple</p>
                    </div>
                </div>

                <div class="bg-slate-700/50 border-2 border-purple-500 rounded-lg p-4 hover:border-purple-400 transition-all cursor-pointer relative" onclick="selectPlan(7, 6)">
                    <div class="absolute -top-3 -right-3 bg-yellow-400 text-black text-xs font-bold px-2 py-1 rounded-full">
                        -14%
                    </div>
                    <div class="text-center">
                        <p class="text-2xl font-bold text-purple-400">6 USDT</p>
                        <p class="text-sm text-gray-400 mt-1">7 jours</p>
                        <p class="text-xs text-gray-500 mt-2">0.86 USDT/jour</p>
                        <p class="text-xs text-green-400 mt-1">‚≠ê Populaire</p>
                    </div>
                </div>

                <div class="bg-slate-700/50 border-2 border-yellow-500 rounded-lg p-4 hover:border-purple-400 transition-all cursor-pointer relative" onclick="selectPlan(30, 20)">
                    <div class="absolute -top-3 -right-3 bg-yellow-400 text-black text-xs font-bold px-2 py-1 rounded-full">
                        -33%
                    </div>
                    <div class="text-center">
                        <p class="text-2xl font-bold text-yellow-400">20 USDT</p>
                        <p class="text-sm text-gray-400 mt-1">30 jours</p>
                        <p class="text-xs text-gray-500 mt-2">0.67 USDT/jour</p>
                        <p class="text-xs text-yellow-400 mt-1">üèÜ Meilleure valeur</p>
                    </div>
                </div>
            </div>

            <div id="selectedPlanInfo" class="bg-blue-500/20 border border-blue-500 rounded-lg p-4 mb-4 hidden">
                <p class="text-blue-300 font-bold mb-2">üìã Forfait s√©lectionn√©</p>
                <p class="text-sm text-blue-200">
                    <span id="planDuration"></span> jours pour <span id="planPrice"></span> USDT
                </p>
            </div>

            <button onclick="processPayment()" id="paymentBtn" class="w-full flex items-center justify-center gap-2 px-6 py-4 bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 rounded-lg font-bold text-lg transition-all disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                <span>üí≥</span>
                <span id="paymentBtnText">S√©lectionnez un forfait</span>
            </button>

            <div class="mt-4 p-3 bg-slate-700/50 rounded-lg">
                <p class="text-xs text-gray-400 text-center">
                    üîí Paiement s√©curis√© via BSC ‚Ä¢ Pas de donn√©es bancaires requises
                </p>
            </div>
        </div>

        <div id="cryptoSelector" class="bg-slate-800/50 backdrop-blur-sm border border-slate-700 rounded-xl p-6 mb-6 hidden">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">S√©lectionner la Crypto</h3>
                <button onclick="fetchCryptoList()" id="refreshBtn" class="flex items-center gap-2 px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg transition-all">
                    <span id="refreshIcon">üîÑ</span>
                    <span id="refreshText">Actualiser</span>
                </button>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm text-gray-400 mb-2">Cryptomonnaie <span id="cryptoCount"></span></label>
                    <select id="cryptoSelect" onchange="changeCrypto()" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-3 focus:outline-none focus:border-yellow-400 text-lg font-semibold cursor-pointer">
                        <option>Chargement...</option>
                    </select>
                    <p class="text-xs text-gray-400 mt-2">üíé = Trading r√©el OK ‚Ä¢ üéÆ = Simulation</p>
                </div>
                
                <div>
                    <label class="block text-sm text-gray-400 mb-2">Mode de Trading</label>
                    <select id="tradingMode" onchange="changeTradingMode()" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-3 focus:outline-none focus:border-yellow-400 text-lg font-semibold cursor-pointer">
                        <option value="simulation">üéÆ Simulation</option>
                        <option value="real">üíé R√©el (PancakeSwap)</option>
                    </select>
                    <p class="text-xs text-gray-400 mt-2" id="modeInfo">‚ö†Ô∏è Activez uniquement si vous comprenez les risques</p>
                </div>
            </div>
        </div>

        <div id="privateKeySection" class="bg-gradient-to-r from-red-500/20 to-orange-500/20 border-2 border-red-500 rounded-xl p-6 mb-6 hidden">
            <h3 class="text-xl font-bold mb-4 flex items-center gap-2">
                <span>üîê</span>
                Trading Automatique 24/7 (Optionnel)
            </h3>
            
            <div class="bg-red-900/30 border border-red-500 rounded-lg p-4 mb-4">
                <p class="text-red-300 font-bold mb-2">‚ö†Ô∏è AVERTISSEMENTS CRITIQUES</p>
                <ul class="text-sm text-red-200 space-y-1">
                    <li>‚Ä¢ Utilisez UNIQUEMENT un wallet d√©di√© avec petit capital</li>
                    <li>‚Ä¢ Votre cl√© priv√©e ne sera JAMAIS sauvegard√©e</li>
                    <li>‚Ä¢ Stock√©e uniquement en m√©moire pendant la session</li>
                    <li>‚Ä¢ Effac√©e automatiquement √† la fermeture de l'onglet</li>
                    <li>‚Ä¢ Laissez vide pour utiliser MetaMask (manuel)</li>
                    <li>‚Ä¢ <strong>MODE 24/7: Gardez l'onglet ouvert et l'√©cran allum√©</strong></li>
                </ul>
            </div>

            <div class="space-y-4">
                <div>
                    <label class="block text-sm text-gray-400 mb-2">Cl√© Priv√©e (pour trading automatique sans confirmation)</label>
                    <input type="password" id="privateKeyInput" placeholder="0x... ou laisser vide pour MetaMask" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-3 focus:outline-none focus:border-red-400">
                    <p class="text-xs text-gray-400 mt-1">
                        <span class="text-yellow-400">‚ö°</span> Vide = Mode manuel (MetaMask) | Rempli = Mode automatique 24/7
                    </p>
                </div>
                
                <button onclick="togglePrivateKeyVisibility()" class="text-sm text-blue-400 hover:underline">
                    üëÅÔ∏è Afficher/Masquer la cl√©
                </button>
            </div>
        </div>

        <div id="capitalSection" class="bg-gradient-to-r from-yellow-400/20 to-orange-500/20 border-2 border-yellow-400 rounded-xl p-6 mb-6 hidden">
            <h3 class="text-xl font-bold mb-4 flex items-center gap-2">
                <span>üéØ</span>
                Capital de trading en USDT
            </h3>
            <p class="text-gray-300 mb-4">
                Montant en USDT pour le trading automatique
                <br />
                <span class="text-sm text-gray-400">Solde disponible: <span id="availableBalance" class="font-bold text-green-400">0</span> USDT</span>
            </p>
            <div class="flex gap-4 mb-3">
                <input type="number" id="capitalInput" placeholder="Ex: 50" step="10" class="flex-1 bg-slate-700 border border-slate-600 rounded-lg px-4 py-3 focus:outline-none focus:border-yellow-400">
                <button onclick="setCapital()" class="px-8 py-3 bg-gradient-to-r from-yellow-400 to-orange-500 hover:from-yellow-500 hover:to-orange-600 rounded-lg font-semibold transition-all">
                    Valider
                </button>
            </div>
            <div class="flex gap-2">
                <button onclick="setMaxCapital()" class="flex-1 px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-sm transition-all">
                    üíØ Utiliser 100%
                </button>
                <button onclick="setHalfCapital()" class="flex-1 px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-sm transition-all">
                    ‚ûó Utiliser 50%
                </button>
                <button onclick="syncWalletBalance()" class="flex-1 px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg text-sm transition-all">
                    üîÑ Actualiser
                </button>
            </div>
        </div>

        <div id="statsCards" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8 hidden">
            <div class="bg-slate-800/50 backdrop-blur-sm border border-slate-700 rounded-xl p-4">
                <p class="text-gray-400 text-xs">Capital</p>
                <p class="text-xl font-bold mt-1 text-green-400">$<span id="capitalDisplay">0</span></p>
            </div>
            
            <div class="bg-slate-800/50 backdrop-blur-sm border border-slate-700 rounded-xl p-4">
                <p class="text-gray-400 text-xs">Prix <span id="cryptoName">BTC</span></p>
                <p class="text-xl font-bold mt-1">$<span id="currentPrice">...</span></p>
            </div>
            
            <div class="bg-slate-800/50 backdrop-blur-sm border border-slate-700 rounded-xl p-4">
                <p class="text-gray-400 text-xs">Profit</p>
                <p class="text-xl font-bold mt-1 text-green-400">$<span id="profitDisplay">0.00</span></p>
            </div>
            
            <div class="bg-slate-800/50 backdrop-blur-sm border border-slate-700 rounded-xl p-4">
                <p class="text-gray-400 text-xs">Mode</p>
                <p class="text-xl font-bold mt-1" id="modeDisplay">üéÆ SIM</p>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="lg:col-span-2 space-y-6">
                <div class="bg-slate-800/50 backdrop-blur-sm border border-slate-700 rounded-xl p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold">üìà Graphique de Trading</h2>
                        <div class="text-sm text-gray-400">
                            <span id="chartCrypto">BTC</span>/USDT
                        </div>
                    </div>
                    <div class="h-64">
                        <canvas id="tradingChart"></canvas>
                    </div>
                </div>

                <div class="bg-slate-800/50 backdrop-blur-sm border border-slate-700 rounded-xl p-6">
                    <h2 class="text-2xl font-bold mb-4">Strat√©gies</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="strategiesGrid"></div>
                </div>

                <div class="bg-slate-800/50 backdrop-blur-sm border border-slate-700 rounded-xl p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold">Historique des Trades</h2>
                        <button onclick="toggleBot()" id="toggleBotBtn" disabled class="flex items-center gap-2 px-6 py-2 rounded-lg font-semibold transition-all bg-gray-600 cursor-not-allowed">
                            <span id="botIcon">‚ñ∂Ô∏è</span>
                            <span id="botText">D√©marrer</span>
                        </button>
                    </div>
                    <div id="tradesContainer">
                        <div class="text-center py-8 text-gray-400">
                            <span class="text-4xl">‚ö†Ô∏è</span>
                            <p>Aucun trade</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="bg-slate-800/50 backdrop-blur-sm border border-slate-700 rounded-xl p-6">
                <h2 class="text-2xl font-bold mb-4">Param√®tres</h2>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">% par trade</label>
                        <input type="number" id="tradePercent" value="10" min="1" max="100" onchange="updateTradeAmount()" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-2 focus:outline-none focus:border-yellow-400">
                        <p class="text-xs text-gray-400 mt-1">Montant: $<span id="tradeAmount">0</span></p>
                    </div>
                    
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">Slippage (%)</label>
                        <input type="number" id="slippage" value="1" step="0.1" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-2 focus:outline-none focus:border-yellow-400">
                        <p class="text-xs text-gray-400 mt-1">‚ö†Ô∏è Recommand√©: 1-2% pour tokens volatils</p>
                    </div>
                </div>

                <div class="mt-6 p-4 bg-green-400/10 border border-green-400/30 rounded-lg">
                    <div class="flex gap-2">
                        <span class="text-green-400">üí∞</span>
                        <div class="text-sm text-gray-300">
                            <p class="font-semibold text-green-400">Soldes</p>
                            <p>BNB: <span id="bnbBalance">0</span></p>
                            <p>USDT: $<span id="usdtBalance">0</span></p>
                        </div>
                    </div>
                </div>

                <div class="mt-4 p-4 bg-blue-400/10 border border-blue-400/30 rounded-lg">
                    <div class="flex gap-2">
                        <span class="text-blue-400">üìä</span>
                        <div class="text-sm text-gray-300">
                            <p class="font-semibold text-blue-400">Statut</p>
                            <p>Wallet: <span id="walletStatus">üî¥ Non connect√©</span></p>
                            <p>Mode: <span id="tradingTypeStatus">üü° ...</span></p>
                            <p>Position: <span id="positionStatus">‚ö™ Aucune</span></p>
                            <p>Binance: <span id="apiStatus">üü° ...</span></p>
                            <p>Ethers: <span id="ethersStatus">üü° ...</span></p>
                        </div>
                    </div>
                </div>

                <div class="mt-4 p-4 bg-red-400/10 border border-red-400/30 rounded-lg">
                    <div class="flex gap-2">
                        <span class="text-red-400">‚ö†Ô∏è</span>
                        <div class="text-xs text-gray-300">
                            <p class="font-semibold text-red-400">ATTENTION</p>
                            <p>‚Ä¢ Risque de perte totale</p>
                            <p>‚Ä¢ Frais gas + slippage</p>
                            <p>‚Ä¢ Minimum 0.01 BNB pour gas</p>
                            <p>‚Ä¢ Commencez petit (10-50$)</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Chat Communautaire -->
    <div id="chatModal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-4" style="z-index: 9999;">
        <div class="bg-gradient-to-br from-slate-900 to-slate-800 rounded-2xl shadow-2xl w-full max-w-4xl h-[600px] flex flex-col border-2 border-purple-500/30">
            <!-- Header Chat -->
            <div class="flex justify-between items-center p-6 border-b border-slate-700">
                <div>
                    <h2 class="text-2xl font-bold bg-gradient-to-r from-green-400 to-teal-400 bg-clip-text text-transparent">
                        üí¨ Chat Communautaire Live
                    </h2>
                    <p class="text-sm text-gray-400 mt-1">
                        <span id="onlineCount" class="text-green-400">‚óè</span> 
                        <span id="onlineUsers">...</span> membres en ligne
                    </p>
                </div>
                <button onclick="closeChat()" class="text-gray-400 hover:text-white transition-all text-2xl hover:bg-red-500/20 rounded-lg px-3 py-1">‚úï</button>
            </div>

            <!-- Messages Area -->
            <div id="chatMessages" class="flex-1 overflow-y-auto p-6 space-y-4 bg-slate-900/50">
                <div class="text-center text-gray-500 py-8">
                    <p>üí¨ Chargement des messages...</p>
                </div>
            </div>

            <!-- Input Area -->
            <div class="p-4 border-t border-slate-700 bg-slate-900">
                <div class="flex gap-3">
                    <input 
                        type="text" 
                        id="chatInput" 
                        placeholder="Tapez votre message..."
                        class="flex-1 bg-slate-700/50 border border-slate-600 rounded-lg px-4 py-3 focus:outline-none focus:border-green-400 text-white placeholder-gray-400"
                        onkeypress="if(event.key === 'Enter') sendMessage()"
                    >
                    <button onclick="sendMessage()" class="px-6 py-3 bg-gradient-to-r from-green-500 to-teal-600 hover:from-green-600 hover:to-teal-700 rounded-lg font-semibold transition-all">
                        Envoyer üì§
                    </button>
                </div>
                <p class="text-xs text-gray-500 mt-2">
                    üí° Partagez vos strat√©gies et analyses avec la communaut√©
                </p>
            </div>
        </div>
    </div>

    <script>
        const PANCAKE_ROUTER = '0x10ED43C718714eb63d5aA57B78B54704E256024E';
        const USDT_CONTRACT = '0x55d398326f99059fF775485246999027B3197955';
        const BSC_RPC = 'https://bsc-dataseed1.binance.org';
        
        const OWNER_WALLET = '0x5959f13ad996ab184780a778cf6d594786f44250';
        const FREE_WALLET = '0xb44dd82c004a767d23b890f788fd6f9b13fcf6a4';
        const FREE_TRIAL_DAYS = 2;

        let state = {
            account: null, 
            isConnected: false, 
            balanceBNB: '0', 
            balanceUSDT: '0',
            selectedCrypto: 'BTCUSDT', 
            cryptoList: [], 
            currentPrice: null, 
            priceHistory: [],
            tradingCapital: 0, 
            capitalSet: false, 
            tradingMode: 'simulation',
            botRunning: false, 
            trades: [], 
            portfolio: { profit: 0, profitPercent: 0 },
            indicators: { rsi: 50, macd: { histogram: 0 }, ema20: 0, ema50: 0 },
            selectedStrategy: 'scalping', 
            provider: null,
            privateKey: null,
            wallet: null,
            autoMode: false,
            currentPosition: null,
            lastBuyPrice: 0,
            positionAmount: 0,
            lastSellTime: 0,
            lastBuyTime: 0,
            positionSold: false, // Flag pour tracker si la position a √©t√© vendue
            chartData: { labels: [], prices: [], buyPoints: [], sellPoints: [] },
            subscription: {
                isActive: false,
                expiryDate: null,
                firstAccessDate: null,
                selectedPlan: null
            },
            // Nouveaux param√®tres pour la v√©rification de baisse
            priceMonitoring: {
                highestPrice: 0,
                highestPriceTime: 0,
                isDropping: false,
                dropStartTime: 0
            }
        };

        let ws = null, botInterval = null, lastTradeTime = 0;
        let tradingChart = null;
        let wakeLock = null;
        let audioContext = null;
        let positionUpdateInterval = null;
        
        // Variables pour le chat
        let chatMessages = [];
        let chatUsername = '';
        let onlineUsersCount = 0;

        const POST_SELL_COOLDOWN = 120000;
        const MIN_TRADE_INTERVAL = 60000; // 1 minute minimum entre trades
        const PRICE_DROP_WAIT_TIME = 600000; // 10 minutes en millisecondes
        const MIN_DROP_PERCENTAGE = 0.5; // Baisse minimale de 0.5% pour consid√©rer une vraie baisse

        const TOKEN_ADDRESSES = {
            'BTCUSDT': '0x7130d2A12B9BCbFAe4f2634d864A1Ee1Ce3Ead9c',
            'ETHUSDT': '0x2170Ed0880ac9A755fd29B2688956BD959F933F8',
            'BNBUSDT': '0xbb4CdB9CBd36B01bD1cBaEBF2De08d9173bc095c'
        };

        const strategies = {
            scalping: { 
                name: 'Scalping', 
                description: 'Rapide RSI+MACD', 
                minTradeInterval: 180000,
                rsiBuyThreshold: 40,
                rsiBuyStrong: 30,
                rsiSellThreshold: 60,
                rsiSellStrong: 70,
                takeProfit: 1.5,
                stopLoss: -1.0
            },
            swing: { 
                name: 'Swing', 
                description: 'Positions EMA', 
                minTradeInterval: 900000,
                rsiBuyThreshold: 35,
                rsiBuyStrong: 25,
                rsiSellThreshold: 70,
                rsiSellStrong: 75,
                takeProfit: 3.0,
                stopLoss: -2.0
            }
        };

        // Initialization
        window.addEventListener('DOMContentLoaded', () => {
            console.log('üöÄ Bot charg√© - Version OPTIMIS√âE');
            console.log('üíé Trading limit√© √†: BTC, ETH, BNB');
            console.log('‚è±Ô∏è Attente 10 minutes apr√®s baisse d√©tect√©e');
            console.log('üõ°Ô∏è Protection anti-double achat');
            
            if (typeof ethers !== 'undefined') {
                document.getElementById('ethersStatus').innerHTML = 'üü¢ v' + ethers.version;
            } else {
                document.getElementById('ethersStatus').innerHTML = 'üî¥ Erreur';
            }
            
            initChart();
            renderStrategies();
            
            // Auto-connexion si wallet d√©j√† connect√©
            if (window.ethereum && window.ethereum.selectedAddress) {
                connectWallet();
            }
        });

        // Wallet Functions
        async function connectWallet() {
            if (!window.ethereum) {
                alert('‚ùå MetaMask non install√©\n\nVeuillez installer MetaMask pour continuer.');
                return;
            }

            try {
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                const chainId = await window.ethereum.request({ method: 'eth_chainId' });
                
                // V√©rifier si on est sur BSC
                if (chainId !== '0x38') {
                    try {
                        await window.ethereum.request({
                            method: 'wallet_addEthereumChain',
                            params: [{
                                chainId: '0x38',
                                chainName: 'BNB Smart Chain',
                                nativeCurrency: { name: 'BNB', symbol: 'BNB', decimals: 18 },
                                rpcUrls: [BSC_RPC],
                                blockExplorerUrls: ['https://bscscan.com']
                            }]
                        });
                    } catch (switchError) {
                        console.error('Erreur changement r√©seau:', switchError);
                    }
                }
                
                state.account = accounts[0];
                state.provider = new ethers.providers.Web3Provider(window.ethereum);
                state.isConnected = true;
                
                console.log('‚úÖ Wallet connect√©:', state.account);
                
                // Charger les soldes
                try {
                    const bnbBalance = await state.provider.getBalance(state.account);
                    state.balanceBNB = ethers.utils.formatEther(bnbBalance);
                    
                    const usdtContract = new ethers.Contract(
                        USDT_CONTRACT,
                        ['function balanceOf(address) view returns (uint256)'],
                        state.provider
                    );
                    const usdtBalance = await usdtContract.balanceOf(state.account);
                    state.balanceUSDT = ethers.utils.formatUnits(usdtBalance, 18);
                    
                    console.log('üí∞ BNB:', state.balanceBNB);
                    console.log('üíµ USDT:', state.balanceUSDT);
                    
                    // Sugg√©rer le capital disponible
                    if (parseFloat(state.balanceUSDT) > 0) {
                        document.getElementById('capitalInput').value = Math.floor(parseFloat(state.balanceUSDT));
                    }
                } catch (balanceError) {
                    console.error('Erreur lecture soldes:', balanceError);
                }
                
                await checkSubscription();
                updateUI();
                
                // Charger les cryptos SEULEMENT apr√®s connexion wallet
                fetchCryptoList();
                
            } catch (error) {
                console.error('‚ùå Erreur connexion:', error);
                alert('Erreur connexion wallet: ' + error.message);
            }
        }

        function checkSubscription() {
            const walletLower = state.account.toLowerCase();
            
            // Wallet gratuit VIP
            if (walletLower === FREE_WALLET.toLowerCase()) {
                state.subscription.isActive = true;
                state.subscription.expiryDate = new Date(2099, 11, 31);
                console.log('üëë Acc√®s VIP gratuit activ√©');
                return true;
            }
            
            // V√©rifier abonnement payant
            const savedSub = localStorage.getItem(`subscription_${walletLower}`);
            if (savedSub) {
                const subData = JSON.parse(savedSub);
                const expiryDate = new Date(subData.expiryDate);
                const now = new Date();
                
                if (now < expiryDate) {
                    state.subscription.isActive = true;
                    state.subscription.expiryDate = expiryDate;
                    const daysLeft = Math.ceil((expiryDate - now) / (1000 * 60 * 60 * 24));
                    console.log(`‚úÖ Abonnement actif - ${daysLeft} jours restants`);
                    return true;
                }
            }
            
            // V√©rifier p√©riode d'essai gratuite (2 jours)
            const firstAccess = localStorage.getItem(`first_access_${walletLower}`);
            if (!firstAccess) {
                const now = new Date();
                const expiryDate = new Date(now.getTime() + FREE_TRIAL_DAYS * 24 * 60 * 60 * 1000);
                
                localStorage.setItem(`first_access_${walletLower}`, now.toISOString());
                localStorage.setItem(`subscription_${walletLower}`, JSON.stringify({
                    expiryDate: expiryDate.toISOString(),
                    firstAccessDate: now.toISOString(),
                    isTrial: true
                }));
                
                state.subscription.isActive = true;
                state.subscription.expiryDate = expiryDate;
                
                console.log(`üéÅ Essai gratuit ${FREE_TRIAL_DAYS} jours activ√©`);
                
                // Afficher bri√®vement la section abonnement
                document.getElementById('subscriptionSection').classList.remove('hidden');
                document.getElementById('trialDaysRemaining').textContent = 
                    `‚è∞ Essai gratuit: ${FREE_TRIAL_DAYS} jours restants`;
                
                setTimeout(() => {
                    document.getElementById('subscriptionSection').classList.add('hidden');
                }, 4000);
                
                return true;
            } else {
                const firstAccessDate = new Date(firstAccess);
                const now = new Date();
                const trialExpiryDate = new Date(firstAccessDate.getTime() + FREE_TRIAL_DAYS * 24 * 60 * 60 * 1000);
                
                if (now < trialExpiryDate) {
                    const hoursLeft = Math.ceil((trialExpiryDate - now) / (1000 * 60 * 60));
                    const daysLeft = Math.ceil(hoursLeft / 24);
                    
                    state.subscription.isActive = true;
                    state.subscription.expiryDate = trialExpiryDate;
                    
                    console.log(`üéÅ Essai gratuit - ${daysLeft} jours restants`);
                    
                    // Notification
                    document.getElementById('subscriptionSection').classList.remove('hidden');
                    document.getElementById('trialDaysRemaining').textContent = 
                        `‚è∞ Essai gratuit: ${daysLeft} jour${daysLeft > 1 ? 's' : ''} restant${daysLeft > 1 ? 's' : ''}`;
                    
                    setTimeout(() => {
                        document.getElementById('subscriptionSection').classList.add('hidden');
                    }, 3000);
                    
                    return true;
                } else {
                    console.log('‚ùå P√©riode d\'essai expir√©e');
                    document.getElementById('subscriptionSection').classList.remove('hidden');
                    document.getElementById('freeTrialInfo').innerHTML = `
                        <p class="text-red-300 font-bold mb-2">‚è∞ P√âRIODE D'ESSAI EXPIR√âE</p>
                        <p class="text-sm text-red-200">
                            Choisissez un forfait pour continuer.
                        </p>
                    `;
                    document.getElementById('freeTrialInfo').className = 
                        'bg-red-500/20 border border-red-500 rounded-lg p-4 mb-4';
                    
                    state.subscription.isActive = false;
                    return false;
                }
            }
        }

        function selectPlan(days, price) {
            state.subscription.selectedPlan = { days, price };
            document.getElementById('selectedPlanInfo').classList.remove('hidden');
            document.getElementById('planDuration').textContent = days;
            document.getElementById('planPrice').textContent = price;
            document.getElementById('paymentBtn').disabled = false;
            document.getElementById('paymentBtnText').textContent = `Payer ${price} USDT`;
        }

        async function processPayment() {
            alert('Fonction de paiement √† impl√©menter');
        }

        // UI Functions
        function updateUI() {
            if (state.isConnected) {
                document.getElementById('connectBtn').className = 
                    'flex items-center gap-2 px-6 py-3 rounded-lg font-semibold transition-all bg-green-600 hover:bg-green-700';
                document.getElementById('walletText').textContent = 
                    `${state.account.slice(0, 6)}...${state.account.slice(-4)}`;
                document.getElementById('walletStatus').innerHTML = 'üü¢ Connect√©';
                
                // Afficher les sections seulement si abonnement actif
                if (state.subscription.isActive) {
                    document.getElementById('cryptoSelector').classList.remove('hidden');
                    document.getElementById('privateKeySection').classList.remove('hidden');
                    document.getElementById('capitalSection').classList.remove('hidden');
                }
                
                // Mettre √† jour les soldes
                document.getElementById('bnbBalance').textContent = parseFloat(state.balanceBNB).toFixed(4);
                document.getElementById('usdtBalance').textContent = parseFloat(state.balanceUSDT).toFixed(2);
                document.getElementById('availableBalance').textContent = parseFloat(state.balanceUSDT).toFixed(2);
            }
            
            if (state.capitalSet) {
                document.getElementById('capitalSection').classList.add('hidden');
                document.getElementById('statsCards').classList.remove('hidden');
                document.getElementById('capitalDisplay').textContent = state.tradingCapital.toFixed(2);
                updateTradeAmount();
            }
            
            // Mettre √† jour le mode de trading
            if (state.tradingMode === 'real') {
                document.getElementById('modeDisplay').innerHTML = 'üíé R√âEL';
                document.getElementById('modeDisplay').className = 'text-xl font-bold mt-1 text-orange-400';
            } else {
                document.getElementById('modeDisplay').innerHTML = 'üéÆ SIM';
                document.getElementById('modeDisplay').className = 'text-xl font-bold mt-1 text-blue-400';
            }
            
            // Mettre √† jour le type de trading
            if (state.autoMode) {
                document.getElementById('tradingTypeStatus').innerHTML = 'ü§ñ Automatique 24/7';
            } else if (state.isConnected) {
                document.getElementById('tradingTypeStatus').innerHTML = 'üì± Manuel MetaMask';
            } else {
                document.getElementById('tradingTypeStatus').innerHTML = 'üü° Non configur√©';
            }
        }

        function initChart() {
            const ctx = document.getElementById('tradingChart').getContext('2d');
            tradingChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Prix',
                        data: [],
                        borderColor: 'rgb(59, 130, 246)',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
        }

        function renderStrategies() {
            document.getElementById('strategiesGrid').innerHTML = Object.entries(strategies).map(([key, s]) => `
                <div onclick="selectStrategy('${key}')" class="p-4 rounded-lg border-2 ${state.selectedStrategy === key ? 'border-yellow-400 bg-yellow-400/10' : 'border-slate-600'} cursor-pointer">
                    <h3 class="font-bold mb-2">${s.name}</h3>
                    <p class="text-gray-400 text-sm">${s.description}</p>
                </div>
            `).join('');
        }

        function selectStrategy(key) {
            state.selectedStrategy = key;
            renderStrategies();
        }

        // Crypto Functions
        async function fetchCryptoList() {
            document.getElementById('refreshIcon').classList.add('animate-spin');
            document.getElementById('refreshText').textContent = 'Chargement...';
            
            try {
                let data = null;
                
                // M√©thode 1: Essayer avec un proxy CORS
                try {
                    console.log('üì° Tentative via proxy CORS...');
                    const proxyUrl = 'https://api.allorigins.win/raw?url=';
                    const apiUrl = encodeURIComponent('https://api.binance.com/api/v3/ticker/24hr');
                    const response = await fetch(proxyUrl + apiUrl, {
                        method: 'GET',
                        headers: { 'Accept': 'application/json' }
                    });
                    data = await response.json();
                    console.log('‚úÖ Donn√©es r√©cup√©r√©es via proxy');
                } catch (proxyError) {
                    console.log('‚ö†Ô∏è Proxy √©chou√©:', proxyError.message);
                    
                    // M√©thode 2: Essayer directement (peut √©chouer √† cause de CORS)
                    try {
                        console.log('üì° Tentative directe...');
                        const response = await fetch('https://api.binance.com/api/v3/ticker/24hr');
                        data = await response.json();
                        console.log('‚úÖ Donn√©es r√©cup√©r√©es directement');
                    } catch (directError) {
                        console.log('‚ö†Ô∏è API directe √©chou√©e:', directError.message);
                        throw new Error('Impossible de r√©cup√©rer les donn√©es');
                    }
                }
                
                if (!data || !Array.isArray(data)) {
                    throw new Error('Format de donn√©es invalide');
                }
                
                // Traiter les donn√©es re√ßues - FILTRER UNIQUEMENT BTC, ETH, BNB
                const allowedSymbols = ['BTCUSDT', 'ETHUSDT', 'BNBUSDT'];
                const topCryptos = data
                    .filter(item => allowedSymbols.includes(item.symbol))
                    .sort((a, b) => parseFloat(b.volume) - parseFloat(a.volume));
                
                state.cryptoList = topCryptos.map(item => ({
                    symbol: item.symbol,
                    name: item.symbol.replace('USDT', ''),
                    price: parseFloat(item.lastPrice),
                    priceChange: parseFloat(item.priceChangePercent),
                    volume: parseFloat(item.volume),
                    realTradingAvailable: !!TOKEN_ADDRESSES[item.symbol]
                }));
                
                // Trier par ordre: BTC, ETH, BNB
                state.cryptoList.sort((a, b) => {
                    const order = { 'BTCUSDT': 1, 'ETHUSDT': 2, 'BNBUSDT': 3 };
                    return order[a.symbol] - order[b.symbol];
                });
                
                document.getElementById('cryptoSelect').innerHTML = state.cryptoList.map(c => 
                    `<option value="${c.symbol}">${c.name} - ${c.price.toFixed(c.price < 1 ? 6 : 2)} ${c.realTradingAvailable ? 'üíé' : 'üéÆ'}</option>`
                ).join('');
                
                if (state.cryptoList.length > 0) {
                    state.selectedCrypto = state.cryptoList[0].symbol;
                    connectWebSocket();
                }
                
                document.getElementById('cryptoCount').textContent = `(${state.cryptoList.length})`;
                document.getElementById('apiStatus').innerHTML = 'üü¢ En ligne';
                console.log(`‚úÖ ${state.cryptoList.length} cryptos charg√©es`);
                
            } catch (error) {
                console.error('‚ùå Erreur compl√®te:', error);
                
                // Fallback: charger une liste par d√©faut
                console.log('üìã Chargement de la liste par d√©faut...');
                loadDefaultCryptoList();
            } finally {
                document.getElementById('refreshIcon').classList.remove('animate-spin');
                document.getElementById('refreshText').textContent = 'Actualiser';
            }
        }
        
        function loadDefaultCryptoList() {
            // UNIQUEMENT BTC, ETH, BNB
            const defaultCryptos = [
                { symbol: 'BTCUSDT', name: 'BTC', price: 95000, priceChange: 2.5, volume: 50000000000 },
                { symbol: 'ETHUSDT', name: 'ETH', price: 3400, priceChange: 1.8, volume: 20000000000 },
                { symbol: 'BNBUSDT', name: 'BNB', price: 650, priceChange: -0.5, volume: 3000000000 }
            ];
            
            state.cryptoList = defaultCryptos.map(c => ({
                ...c,
                realTradingAvailable: !!TOKEN_ADDRESSES[c.symbol]
            }));
            
            document.getElementById('cryptoSelect').innerHTML = state.cryptoList.map(c => 
                `<option value="${c.symbol}">${c.name} - ${c.price.toFixed(c.price < 1 ? 6 : 2)} ${c.realTradingAvailable ? 'üíé' : 'üéÆ'}</option>`
            ).join('');
            
            if (state.cryptoList.length > 0) {
                state.selectedCrypto = state.cryptoList[0].symbol;
                connectWebSocket();
            }
            
            document.getElementById('cryptoCount').textContent = `(${state.cryptoList.length})`;
            document.getElementById('apiStatus').innerHTML = 'üü° Mode Hors Ligne';
            
            console.log('‚úÖ Liste charg√©e - BTC, ETH, BNB uniquement');
            
            // Afficher un message √† l'utilisateur
            const message = document.createElement('div');
            message.className = 'fixed top-4 right-4 bg-blue-500/20 border border-blue-500 rounded-lg p-4 max-w-md z-50';
            message.innerHTML = `
                <p class="text-blue-300 font-bold mb-2">üíé Trading Limit√©</p>
                <p class="text-sm text-blue-200">
                    Trading disponible pour:<br>
                    ‚Ä¢ BTC (Bitcoin)<br>
                    ‚Ä¢ ETH (Ethereum)<br>
                    ‚Ä¢ BNB (Binance Coin)
                </p>
            `;
            document.body.appendChild(message);
            
            setTimeout(() => message.remove(), 6000);
        }

        function changeCrypto() {
            state.selectedCrypto = document.getElementById('cryptoSelect').value;
            state.priceHistory = [];
            state.currentPosition = null; // Reset position lors du changement
            state.lastBuyTime = 0;
            state.lastSellTime = 0;
            state.positionSold = false; // Reset du flag de vente
            state.positionAmount = 0;
            state.lastBuyPrice = 0;
            // R√©initialiser le monitoring du prix
            state.priceMonitoring = {
                highestPrice: 0,
                highestPriceTime: 0,
                isDropping: false,
                dropStartTime: 0
            };
            document.getElementById('positionStatus').innerHTML = '‚ö™ Aucune';
            console.log(`üîÑ Changement vers ${state.selectedCrypto} - Tous les √©tats r√©initialis√©s`);
            connectWebSocket();
        }

        function changeTradingMode() {
            state.tradingMode = document.getElementById('tradingMode').value;
            updateUI();
        }

        function connectWebSocket() {
            if (ws) {
                ws.close();
                ws = null;
            }
            
            try {
                const symbol = state.selectedCrypto.toLowerCase();
                console.log('üîå Connexion WebSocket:', symbol);
                
                ws = new WebSocket(`wss://stream.binance.com:9443/ws/${symbol}@ticker`);
                
                ws.onopen = () => {
                    console.log('‚úÖ WebSocket connect√©');
                    document.getElementById('apiStatus').innerHTML = 'üü¢ En ligne';
                };
                
                ws.onmessage = (event) => {
                    try {
                        const data = JSON.parse(event.data);
                        state.currentPrice = parseFloat(data.c);
                        
                        state.priceHistory.push(state.currentPrice);
                        if (state.priceHistory.length > 100) state.priceHistory.shift();
                        
                        // Mettre √† jour l'affichage
                        document.getElementById('currentPrice').textContent = state.currentPrice.toFixed(2);
                        document.getElementById('cryptoName').textContent = state.selectedCrypto.replace('USDT', '');
                        
                        // Mettre √† jour le graphique toutes les 5 secondes
                        if (state.priceHistory.length % 5 === 0) {
                            updateChart();
                        }
                    } catch (error) {
                        console.error('Erreur parsing WebSocket:', error);
                    }
                };
                
                ws.onerror = (error) => {
                    console.error('‚ùå WebSocket erreur:', error);
                    document.getElementById('apiStatus').innerHTML = 'üî¥ D√©connect√©';
                };
                
                ws.onclose = () => {
                    console.log('üîå WebSocket ferm√©');
                    document.getElementById('apiStatus').innerHTML = 'üü° D√©connect√©';
                    
                    // Tentative de reconnexion apr√®s 5 secondes
                    setTimeout(() => {
                        if (!ws || ws.readyState === WebSocket.CLOSED) {
                            console.log('üîÑ Tentative de reconnexion...');
                            connectWebSocket();
                        }
                    }, 5000);
                };
            } catch (error) {
                console.error('‚ùå Erreur connexion WebSocket:', error);
                document.getElementById('apiStatus').innerHTML = 'üî¥ Erreur';
            }
        }
        
        function updateChart() {
            if (!tradingChart || state.priceHistory.length === 0) return;
            
            const maxPoints = 50;
            const prices = state.priceHistory.slice(-maxPoints);
            const labels = prices.map((_, i) => {
                const now = new Date();
                const time = new Date(now.getTime() - (maxPoints - i - 1) * 5000);
                return time.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            });
            
            tradingChart.data.labels = labels;
            tradingChart.data.datasets[0].data = prices;
            tradingChart.update('none');
        }

        // Trading Functions
        function togglePrivateKeyVisibility() {
            const input = document.getElementById('privateKeyInput');
            input.type = input.type === 'password' ? 'text' : 'password';
        }

        function setCapital() {
            const capital = parseFloat(document.getElementById('capitalInput').value);
            
            if (!capital || capital <= 0) {
                alert('‚ùå Montant invalide');
                return;
            }
            
            state.tradingCapital = capital;
            state.capitalSet = true;
            
            document.getElementById('capitalSection').classList.add('hidden');
            document.getElementById('statsCards').classList.remove('hidden');
            document.getElementById('capitalDisplay').textContent = capital.toFixed(2);
            document.getElementById('toggleBotBtn').disabled = false;
            document.getElementById('toggleBotBtn').className = 
                'flex items-center gap-2 px-6 py-2 rounded-lg font-semibold transition-all bg-green-600 hover:bg-green-700';
            
            updateTradeAmount();
            alert(`‚úÖ Capital d√©fini: ${capital} USDT`);
        }

        function setMaxCapital() {
            document.getElementById('capitalInput').value = 100;
        }

        function setHalfCapital() {
            document.getElementById('capitalInput').value = 50;
        }

        function syncWalletBalance() {
            alert('Fonction de synchronisation en cours de d√©veloppement');
        }

        function updateTradeAmount() {
            const percent = parseFloat(document.getElementById('tradePercent').value);
            const amount = (state.tradingCapital * percent / 100).toFixed(2);
            document.getElementById('tradeAmount').textContent = amount;
        }

        function toggleBot() {
            if (!state.subscription.isActive) {
                alert('‚ùå Abonnement requis');
                document.getElementById('subscriptionSection').classList.remove('hidden');
                return;
            }
            
            if (!state.capitalSet) {
                alert('‚ùå D√©finissez le capital');
                return;
            }
            
            state.botRunning = !state.botRunning;
            
            if (state.botRunning) {
                startBot();
                alert('‚úÖ Bot d√©marr√© en mode ' + (state.tradingMode === 'real' ? 'R√âEL' : 'SIMULATION') + 
                      '\n\nüõ°Ô∏è Protection anti-double achat active' +
                      '\n‚è±Ô∏è Attente 10 min apr√®s d√©tection baisse' +
                      '\nüíé Trading: BTC, ETH, BNB uniquement');
            } else {
                stopBot();
            }
            
            updateBotButton();
        }

        function updateBotButton() {
            const btn = document.getElementById('toggleBotBtn');
            if (state.botRunning) {
                btn.className = 'flex items-center gap-2 px-6 py-2 rounded-lg font-semibold transition-all bg-red-600 hover:bg-red-700';
                document.getElementById('botIcon').textContent = '‚è∏Ô∏è';
                document.getElementById('botText').textContent = 'Arr√™ter';
            } else {
                btn.className = 'flex items-center gap-2 px-6 py-2 rounded-lg font-semibold transition-all bg-green-600 hover:bg-green-700';
                document.getElementById('botIcon').textContent = '‚ñ∂Ô∏è';
                document.getElementById('botText').textContent = 'D√©marrer';
            }
        }

        function startBot() {
            console.log('üöÄ Bot d√©marr√© - Version avec Baisse 10min + BTC/ETH/BNB uniquement');
            console.log('üõ°Ô∏è Protection anti-double achat ACTIVE');
            console.log('‚è±Ô∏è Attente 10 minutes apr√®s d√©tection de baisse');
            
            // R√©initialiser le monitoring au d√©marrage
            state.priceMonitoring = {
                highestPrice: state.currentPrice || 0,
                highestPriceTime: Date.now(),
                isDropping: false,
                dropStartTime: 0
            };
            
            botInterval = setInterval(() => {
                if (state.priceHistory.length < 20) {
                    console.log('‚è≥ Collecte des donn√©es...');
                    return;
                }
                
                const signal = getTradeSignal();
                if (signal.signal) {
                    executeTrade(signal.signal);
                }
            }, 10000); // Check every 10 seconds
        }

        function stopBot() {
            if (botInterval) {
                clearInterval(botInterval);
                botInterval = null;
                console.log('üõë Bot arr√™t√©');
            }
        }

        function updatePriceMonitoring(currentPrice) {
            const now = Date.now();
            const monitoring = state.priceMonitoring;
            
            // Mettre √† jour le prix le plus haut
            if (currentPrice > monitoring.highestPrice || monitoring.highestPrice === 0) {
                monitoring.highestPrice = currentPrice;
                monitoring.highestPriceTime = now;
                monitoring.isDropping = false;
                monitoring.dropStartTime = 0;
                console.log(`üìà Nouveau prix maximum: ${currentPrice.toFixed(2)}`);
                return;
            }
            
            // Calculer la baisse en pourcentage depuis le plus haut
            const dropPercent = ((monitoring.highestPrice - currentPrice) / monitoring.highestPrice) * 100;
            
            // D√©tecter le d√©but d'une baisse
            if (dropPercent >= MIN_DROP_PERCENTAGE && !monitoring.isDropping) {
                monitoring.isDropping = true;
                monitoring.dropStartTime = now;
                console.log(`üìâ Baisse d√©tect√©e: ${dropPercent.toFixed(2)}% depuis ${monitoring.highestPrice.toFixed(2)}`);
            }
            
            // Si le prix remonte, r√©initialiser
            if (monitoring.isDropping && currentPrice > monitoring.highestPrice * 0.995) {
                console.log(`üìà Prix en remont√©e, r√©initialisation du monitoring`);
                monitoring.highestPrice = currentPrice;
                monitoring.highestPriceTime = now;
                monitoring.isDropping = false;
                monitoring.dropStartTime = 0;
            }
        }
        
        function canBuyAfterDrop() {
            const monitoring = state.priceMonitoring;
            const now = Date.now();
            
            // Si pas de baisse en cours, pas d'achat
            if (!monitoring.isDropping) {
                return { canBuy: false, reason: 'Prix stable ou en hausse', waitTime: 0 };
            }
            
            // Calculer le temps √©coul√© depuis le d√©but de la baisse
            const timeElapsed = now - monitoring.dropStartTime;
            
            // Calculer la baisse actuelle
            const dropPercent = ((monitoring.highestPrice - state.currentPrice) / monitoring.highestPrice) * 100;
            
            // Si 10 minutes se sont √©coul√©es et le prix est toujours en baisse
            if (timeElapsed >= PRICE_DROP_WAIT_TIME) {
                return { 
                    canBuy: true, 
                    reason: `Baisse confirm√©e de ${dropPercent.toFixed(2)}% depuis ${Math.floor(timeElapsed / 60000)} minutes`,
                    waitTime: 0
                };
            }
            
            // Sinon, il faut attendre
            const remainingTime = PRICE_DROP_WAIT_TIME - timeElapsed;
            const remainingMinutes = Math.ceil(remainingTime / 60000);
            
            return { 
                canBuy: false, 
                reason: `Baisse de ${dropPercent.toFixed(2)}% d√©tect√©e, attente ${remainingMinutes} min avant achat`,
                waitTime: remainingTime
            };
        }
        
        function getTradeSignal() {
            const rsi = calculateRSI(state.priceHistory);
            const strategy = strategies[state.selectedStrategy];
            const now = Date.now();
            
            // Mettre √† jour le monitoring du prix
            if (state.currentPrice) {
                updatePriceMonitoring(state.currentPrice);
            }
            
            // PROTECTION: V√©rifier qu'on n'a pas d√©j√† une position ouverte
            if (state.currentPosition === 'BUY') {
                console.log(`üìä Position LONG ouverte - RSI: ${rsi.toFixed(2)} - En attente de signal VENTE`);
                
                // VENTE: Seulement si position ouverte ET RSI √©lev√© ET pas encore vendue
                if (rsi > strategy.rsiSellThreshold) {
                    // V√©rifier si la position a d√©j√† √©t√© vendue
                    if (state.positionSold) {
                        console.log(`üîí Position d√©j√† vendue - En attente de nouveau cycle`);
                        return { signal: null, confidence: 0 };
                    }
                    
                    // V√©rifier le d√©lai minimum depuis le dernier achat
                    const timeSinceBuy = now - state.lastBuyTime;
                    if (timeSinceBuy < MIN_TRADE_INTERVAL) {
                        console.log(`‚è±Ô∏è D√©lai minimum non respect√© (${Math.ceil((MIN_TRADE_INTERVAL - timeSinceBuy) / 1000)}s restantes)`);
                        return { signal: null, confidence: 0 };
                    }
                    
                    // V√âRIFICATION SUPPL√âMENTAIRE: S'assurer qu'on a bien une position
                    if (state.positionAmount <= 0) {
                        console.error('üö´ ERREUR: Position amount = 0, impossible de vendre');
                        state.currentPosition = null; // Reset en cas d'incoh√©rence
                        state.positionSold = false;
                        return { signal: null, confidence: 0 };
                    }
                    
                    console.log(`üî¥ Signal VENTE d√©tect√© - RSI: ${rsi.toFixed(2)} - Position: ${state.positionAmount} USDT`);
                    return { signal: 'SELL', confidence: 0.8 };
                }
            } else if (state.currentPosition === null) {
                // ACHAT: Seulement si AUCUNE position ouverte
                if (rsi < strategy.rsiBuyThreshold) {
                    // V√©rifier le d√©lai minimum depuis la derni√®re vente
                    const timeSinceSell = now - state.lastSellTime;
                    if (timeSinceSell < MIN_TRADE_INTERVAL && state.lastSellTime > 0) {
                        console.log(`‚è±Ô∏è D√©lai minimum apr√®s vente (${Math.ceil((MIN_TRADE_INTERVAL - timeSinceSell) / 1000)}s restantes)`);
                        return { signal: null, confidence: 0 };
                    }
                    
                    // NOUVELLE V√âRIFICATION: Le prix doit √™tre en baisse depuis 10 minutes
                    const dropCheck = canBuyAfterDrop();
                    if (!dropCheck.canBuy) {
                        console.log(`‚è≥ ${dropCheck.reason}`);
                        return { signal: null, confidence: 0 };
                    }
                    
                    console.log(`üü¢ Signal ACHAT valid√© - RSI: ${rsi.toFixed(2)} - ${dropCheck.reason}`);
                    return { signal: 'BUY', confidence: 0.8 };
                }
            } else {
                // √âtat incoh√©rent d√©tect√©
                console.error(`‚ö†Ô∏è √âTAT INCOH√âRENT: currentPosition = ${state.currentPosition}`);
                state.currentPosition = null;
                state.positionAmount = 0;
                state.positionSold = false;
            }
            
            return { signal: null, confidence: 0 };
        }

        function calculateRSI(prices, period = 14) {
            if (prices.length < period + 1) return 50;
            
            let gains = 0, losses = 0;
            for (let i = prices.length - period; i < prices.length; i++) {
                const change = prices[i] - prices[i - 1];
                if (change > 0) gains += change;
                else losses += Math.abs(change);
            }
            
            const avgGain = gains / period;
            const avgLoss = losses / period;
            if (avgLoss === 0) return 100;
            
            const rs = avgGain / avgLoss;
            return 100 - (100 / (1 + rs));
        }

        function executeTrade(tradeType) {
            const percent = parseFloat(document.getElementById('tradePercent').value);
            const amount = (state.tradingCapital * percent / 100).toFixed(2);
            const now = Date.now();
            
            // PROTECTION FINALE: Double v√©rification avant ex√©cution
            if (tradeType === 'BUY' && state.currentPosition === 'BUY') {
                console.error('üö´ BLOQU√â: Tentative d\'achat alors qu\'une position est d√©j√† ouverte!');
                return;
            }
            
            if (tradeType === 'SELL') {
                // V√©rifications multiples pour la vente
                if (state.currentPosition !== 'BUY') {
                    console.error('üö´ BLOQU√â: Tentative de vente sans position ouverte!');
                    return;
                }
                
                if (state.positionSold) {
                    console.error('üö´ BLOQU√â: Cette position a d√©j√† √©t√© vendue!');
                    return;
                }
                
                if (state.positionAmount <= 0) {
                    console.error('üö´ BLOQU√â: Montant de position invalide!');
                    return;
                }
            }
            
            console.log(`üìä ${tradeType} ex√©cut√© - ${amount} USDT`);
            
            let profit = 0;
            let profitPercent = 0;
            
            if (tradeType === 'BUY') {
                state.currentPosition = 'BUY';
                state.lastBuyPrice = state.currentPrice;
                state.positionAmount = parseFloat(amount);
                state.lastBuyTime = now;
                state.positionSold = false; // Reset du flag √† l'achat
                document.getElementById('positionStatus').innerHTML = 'üü¢ Long';
                console.log(`‚úÖ ACHAT confirm√© - Prix: ${state.currentPrice} - Position ouverte - Flag vente: ${state.positionSold}`);
                
            } else if (tradeType === 'SELL') {
                profitPercent = ((state.currentPrice - state.lastBuyPrice) / state.lastBuyPrice) * 100;
                profit = state.positionAmount * (profitPercent / 100);
                state.portfolio.profit += profit;
                
                // IMPORTANT: Fermer la position et marquer comme vendue
                state.currentPosition = null;
                state.lastSellTime = now;
                state.positionSold = true; // Marquer la position comme vendue
                const soldAmount = state.positionAmount;
                state.positionAmount = 0;
                state.lastBuyPrice = 0;
                
                document.getElementById('positionStatus').innerHTML = '‚ö™ Aucune';
                console.log(`‚úÖ VENTE confirm√©e - Montant: ${soldAmount} USDT - Profit: ${profit.toFixed(2)} USDT (${profitPercent.toFixed(2)}%)`);
                console.log(`üîí Position FERM√âE - Flag vente: ${state.positionSold} - Nouvelle vente impossible jusqu'au prochain achat`);
            }
            
            const trade = {
                id: Date.now(),
                time: new Date().toLocaleTimeString('fr-FR'),
                type: tradeType,
                pair: state.selectedCrypto,
                amount: amount,
                entryPrice: state.currentPrice.toFixed(6),
                profit: profit.toFixed(2),
                profitPercent: profitPercent.toFixed(2),
                mode: state.tradingMode
            };
            
            state.trades.unshift(trade);
            state.trades = state.trades.slice(0, 50);
            
            renderTrades();
            updateUI();
        }

        function renderTrades() {
            if (state.trades.length === 0) return;
            
            document.getElementById('tradesContainer').innerHTML = state.trades.map(t => `
                <div class="flex items-center justify-between p-4 bg-slate-700/50 rounded-lg mb-2 border-l-4 ${t.type === 'BUY' ? 'border-green-400' : 'border-red-400'}">
                    <div class="flex items-center gap-4">
                        <span class="${t.type === 'BUY' ? 'text-green-400' : 'text-red-400'} text-3xl">
                            ${t.type === 'BUY' ? 'üü¢' : 'üî¥'}
                        </span>
                        <div>
                            <p class="font-bold">${t.type} ${t.pair}</p>
                            <p class="text-xs text-gray-400">${t.time} ‚Ä¢ ${t.amount} USDT</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <p class="font-mono">${t.entryPrice}</p>
                        ${t.type === 'SELL' ? `
                            <p class="font-bold ${parseFloat(t.profit) >= 0 ? 'text-green-400' : 'text-red-400'}">
                                ${parseFloat(t.profit) >= 0 ? '+' : ''}${t.profit} USDT
                            </p>
                        ` : ''}
                    </div>
                </div>
            `).join('');
            
            document.getElementById('profitDisplay').textContent = state.portfolio.profit.toFixed(2);
        }

        function openDCASwap() {
            window.open('https://reboot-20.vercel.app/', '_blank');
        }

        // ============================================
        // FONCTIONS CHAT COMMUNAUTAIRE
        // ============================================

        function openChat() {
            document.getElementById('chatModal').classList.remove('hidden');
            
            // G√©n√©rer un username si pas d√©j√† fait
            if (!chatUsername) {
                if (state.account) {
                    chatUsername = state.account.slice(0, 6) + '...' + state.account.slice(-4);
                } else {
                    chatUsername = 'Trader' + Math.floor(Math.random() * 9999);
                }
            }
            
            console.log('üí¨ Chat ouvert - Username:', chatUsername);
            
            // Simuler le nombre d'utilisateurs en ligne
            simulateOnlineUsers();
            
            // Charger les messages de la session
            loadChatMessages();
            
            // Simulation d'activit√© du chat
            startChatSimulation();
        }

        function closeChat() {
            document.getElementById('chatModal').classList.add('hidden');
        }

        function simulateOnlineUsers() {
            // Simulation r√©aliste d'utilisateurs en ligne
            onlineUsersCount = Math.floor(Math.random() * 50) + 20; // Entre 20 et 70 users
            document.getElementById('onlineUsers').textContent = onlineUsersCount;
            
            // Variation du nombre d'utilisateurs
            setInterval(() => {
                const change = Math.floor(Math.random() * 5) - 2; // +/- 2 users
                onlineUsersCount = Math.max(15, onlineUsersCount + change);
                document.getElementById('onlineUsers').textContent = onlineUsersCount;
            }, 30000); // Toutes les 30 secondes
        }

        function loadChatMessages() {
            // Charger les messages sauvegard√©s
            const savedMessages = localStorage.getItem('chatMessages');
            if (savedMessages) {
                try {
                    chatMessages = JSON.parse(savedMessages);
                    console.log('üí¨ Messages charg√©s depuis localStorage:', chatMessages.length);
                } catch (e) {
                    console.error('Erreur parsing messages:', e);
                    chatMessages = [];
                }
            }
            
            // Messages de bienvenue par d√©faut si vide
            if (chatMessages.length === 0) {
                chatMessages = [
                    {
                        username: 'Admin',
                        message: 'üëã Bienvenue sur le chat communautaire !',
                        timestamp: Date.now() - 3600000,
                        type: 'system'
                    },
                    {
                        username: 'CryptoKing',
                        message: 'BTC en train de casser la r√©sistance des 95k !',
                        timestamp: Date.now() - 1800000,
                        type: 'user'
                    },
                    {
                        username: 'ETHTrader',
                        message: 'J\'ai setup un bot sur ETH avec RSI < 30, super r√©sultats',
                        timestamp: Date.now() - 900000,
                        type: 'user'
                    },
                    {
                        username: 'BNBWhale',
                        message: 'Qui trade BNB ici ? Strat√©gie scalping fonctionne bien',
                        timestamp: Date.now() - 300000,
                        type: 'user'
                    }
                ];
                console.log('üí¨ Messages par d√©faut cr√©√©s:', chatMessages.length);
            }
            
            renderChatMessages();
        }

        function renderChatMessages() {
            const container = document.getElementById('chatMessages');
            
            if (chatMessages.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-gray-400 py-8">
                        <p class="text-4xl mb-4">üí¨</p>
                        <p>Aucun message pour le moment</p>
                        <p class="text-sm mt-2">Soyez le premier √† envoyer un message !</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = chatMessages.map(msg => {
                const time = new Date(msg.timestamp).toLocaleTimeString('fr-FR', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
                
                if (msg.type === 'system') {
                    return `
                        <div class="flex justify-center my-4">
                            <div class="bg-blue-500/20 border border-blue-500/50 rounded-lg px-4 py-2 text-sm text-blue-300">
                                ${escapeHtml(msg.message)}
                            </div>
                        </div>
                    `;
                }
                
                const isOwnMessage = msg.username === chatUsername;
                
                return `
                    <div class="flex ${isOwnMessage ? 'justify-end' : 'justify-start'} mb-4">
                        <div class="max-w-[70%]">
                            <div class="flex items-center gap-2 mb-1 ${isOwnMessage ? 'justify-end' : 'justify-start'}">
                                ${!isOwnMessage ? `
                                    <span class="text-sm font-bold ${getUserColor(msg.username)}">${escapeHtml(msg.username)}</span>
                                ` : ''}
                                <span class="text-xs text-gray-500">${time}</span>
                                ${isOwnMessage ? `
                                    <span class="text-sm font-bold text-green-400">${escapeHtml(msg.username)}</span>
                                ` : ''}
                            </div>
                            <div class="${isOwnMessage ? 
                                'bg-gradient-to-r from-green-600 to-teal-600 text-white' : 
                                'bg-slate-700 text-white border border-slate-600'
                            } rounded-2xl px-4 py-3 shadow-lg">
                                <p class="text-sm leading-relaxed break-words">${escapeHtml(msg.message)}</p>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            // Scroll vers le bas avec animation
            setTimeout(() => {
                container.scrollTop = container.scrollHeight;
            }, 100);
        }

        function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message) {
                // Animation de secousse si vide
                input.style.animation = 'shake 0.5s';
                setTimeout(() => {
                    input.style.animation = '';
                }, 500);
                return;
            }
            
            // Ajouter le message
            const newMessage = {
                username: chatUsername,
                message: message,
                timestamp: Date.now(),
                type: 'user'
            };
            
            chatMessages.push(newMessage);
            
            // Garder seulement les 100 derniers messages
            if (chatMessages.length > 100) {
                chatMessages = chatMessages.slice(-100);
            }
            
            // Sauvegarder dans localStorage
            localStorage.setItem('chatMessages', JSON.stringify(chatMessages));
            
            // Afficher
            renderChatMessages();
            
            // Clear input
            input.value = '';
            
            // Animation d'envoi avec feedback visuel
            const sendButton = event.target || document.querySelector('button[onclick="sendMessage()"]');
            const originalText = sendButton.innerHTML;
            sendButton.innerHTML = '‚úì Envoy√© !';
            sendButton.style.background = 'linear-gradient(to right, #10b981, #14b8a6)';
            
            setTimeout(() => {
                sendButton.innerHTML = originalText;
                sendButton.style.background = '';
            }, 2000);
            
            // Feedback sur l'input
            input.placeholder = 'Message envoy√© ! ‚úì';
            input.style.borderColor = '#10b981';
            setTimeout(() => {
                input.placeholder = 'Tapez votre message...';
                input.style.borderColor = '';
            }, 2000);
            
            console.log('üí¨ Message envoy√©:', message);
        }

        function startChatSimulation() {
            // Simuler des messages de la communaut√©
            const simulatedMessages = [
                { user: 'AlphaTrader', msg: 'Signal haussier sur BTC, MACD en croix dor√©e !' },
                { user: 'CryptoNinja', msg: 'Volume en hausse sur ETH, attention aux breakouts' },
                { user: 'MoonBoy', msg: 'Qui utilise la strat√©gie swing ? R√©sultats ?' },
                { user: 'DiamondHands', msg: 'HODL BTC, le bull run commence üöÄ' },
                { user: 'TechAnalyst', msg: 'RSI en survente sur BNB, opportunit√© d\'achat' },
                { user: 'WhaleWatcher', msg: 'Gros transfert de BTC d√©tect√© sur la blockchain' },
                { user: 'DayTrader', msg: 'Profit de +2.5% sur ETH aujourd\'hui avec le bot' },
                { user: 'CryptoGuru', msg: 'Attention √† la volatilit√©, utilisez des stop loss' },
                { user: 'BTCMaxi', msg: 'BTC > tout le reste, changez mon avis' },
                { user: 'AltCoinKing', msg: 'Les alts vont exploser apr√®s BTC' }
            ];
            
            // Envoyer un message simul√© toutes les 15-45 secondes
            setInterval(() => {
                if (document.getElementById('chatModal').classList.contains('hidden')) return;
                
                const random = simulatedMessages[Math.floor(Math.random() * simulatedMessages.length)];
                
                const simulatedMsg = {
                    username: random.user,
                    message: random.msg,
                    timestamp: Date.now(),
                    type: 'user'
                };
                
                chatMessages.push(simulatedMsg);
                
                if (chatMessages.length > 100) {
                    chatMessages = chatMessages.slice(-100);
                }
                
                localStorage.setItem('chatMessages', JSON.stringify(chatMessages));
                renderChatMessages();
                
            }, Math.random() * 30000 + 15000); // Entre 15 et 45 secondes
        }

        function getUserColor(username) {
            const colors = [
                'text-blue-400',
                'text-green-400',
                'text-yellow-400',
                'text-purple-400',
                'text-pink-400',
                'text-orange-400',
                'text-teal-400',
                'text-cyan-400'
            ];
            
            // Hash simple du username pour couleur consistante
            let hash = 0;
            for (let i = 0; i < username.length; i++) {
                hash = username.charCodeAt(i) + ((hash << 5) - hash);
            }
            
            return colors[Math.abs(hash) % colors.length];
        }

        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, m => map[m]);
        }
    </script>
</body>
</html>                </button>
                
                <button onclick="connectWallet()" id="connectBtn" class="flex items-center gap-2 px-6 py-3 rounded-lg font-semibold transition-all bg-gradient-to-r from-yellow-400 to-orange-500 hover:from-yellow-500 hover:to-orange-600">
                    <span>üëõ</span>
                    <span id="walletText">Connecter MetaMask</span>
                </button>
            </div>
        </div>

        <div id="subscriptionSection" class="bg-gradient-to-r from-purple-500/20 to-pink-500/20 border-2 border-purple-500 rounded-xl p-6 mb-6 hidden">
            <h3 class="text-xl font-bold mb-4 flex items-center gap-2">
                <span>üíé</span>
                Abonnement Bot Trading Pro
            </h3>
            
            <div id="freeTrialInfo" class="bg-green-500/20 border border-green-500 rounded-lg p-4 mb-4">
                <p class="text-green-300 font-bold mb-2">üéÅ OFFRE DE LANCEMENT</p>
                <p class="text-sm text-green-200">
                    ‚úÖ 2 jours GRATUITS pour tester le bot<br>
                    ‚úÖ Toutes les fonctionnalit√©s incluses<br>
                    ‚úÖ Trading r√©el + Simulation<br>
                    <span id="trialDaysRemaining" class="font-bold text-green-400"></span>
                </p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                <div class="bg-slate-700/50 border-2 border-slate-600 rounded-lg p-4 hover:border-purple-400 transition-all cursor-pointer" onclick="selectPlan(1, 1)">
                    <div class="text-center">
                        <p class="text-2xl font-bold text-purple-400">1 USDT</p>
                        <p class="text-sm text-gray-400 mt-1">1 jour</p>
                        <p class="text-xs text-gray-500 mt-2">Essai simple</p>
                    </div>
                </div>

                <div class="bg-slate-700/50 border-2 border-purple-500 rounded-lg p-4 hover:border-purple-400 transition-all cursor-pointer relative" onclick="selectPlan(7, 6)">
                    <div class="absolute -top-3 -right-3 bg-yellow-400 text-black text-xs font-bold px-2 py-1 rounded-full">
                        -14%
                    </div>
                    <div class="text-center">
                        <p class="text-2xl font-bold text-purple-400">6 USDT</p>
                        <p class="text-sm text-gray-400 mt-1">7 jours</p>
                        <p class="text-xs text-gray-500 mt-2">0.86 USDT/jour</p>
                        <p class="text-xs text-green-400 mt-1">‚≠ê Populaire</p>
                    </div>
                </div>

                <div class="bg-slate-700/50 border-2 border-yellow-500 rounded-lg p-4 hover:border-purple-400 transition-all cursor-pointer relative" onclick="selectPlan(30, 20)">
                    <div class="absolute -top-3 -right-3 bg-yellow-400 text-black text-xs font-bold px-2 py-1 rounded-full">
                        -33%
                    </div>
                    <div class="text-center">
                        <p class="text-2xl font-bold text-yellow-400">20 USDT</p>
                        <p class="text-sm text-gray-400 mt-1">30 jours</p>
                        <p class="text-xs text-gray-500 mt-2">0.67 USDT/jour</p>
                        <p class="text-xs text-yellow-400 mt-1">üèÜ Meilleure valeur</p>
                    </div>
                </div>
            </div>

            <div id="selectedPlanInfo" class="bg-blue-500/20 border border-blue-500 rounded-lg p-4 mb-4 hidden">
                <p class="text-blue-300 font-bold mb-2">üìã Forfait s√©lectionn√©</p>
                <p class="text-sm text-blue-200">
                    <span id="planDuration"></span> jours pour <span id="planPrice"></span> USDT
                </p>
            </div>

            <button onclick="processPayment()" id="paymentBtn" class="w-full flex items-center justify-center gap-2 px-6 py-4 bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 rounded-lg font-bold text-lg transition-all disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                <span>üí≥</span>
                <span id="paymentBtnText">S√©lectionnez un forfait</span>
            </button>

            <div class="mt-4 p-3 bg-slate-700/50 rounded-lg">
                <p class="text-xs text-gray-400 text-center">
                    üîí Paiement s√©curis√© via BSC ‚Ä¢ Pas de donn√©es bancaires requises
                </p>
            </div>
        </div>

        <div id="cryptoSelector" class="bg-slate-800/50 backdrop-blur-sm border border-slate-700 rounded-xl p-6 mb-6 hidden">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">S√©lectionner la Crypto</h3>
                <button onclick="fetchCryptoList()" id="refreshBtn" class="flex items-center gap-2 px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg transition-all">
                    <span id="refreshIcon">üîÑ</span>
                    <span id="refreshText">Actualiser</span>
                </button>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm text-gray-400 mb-2">Cryptomonnaie <span id="cryptoCount"></span></label>
                    <select id="cryptoSelect" onchange="changeCrypto()" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-3 focus:outline-none focus:border-yellow-400 text-lg font-semibold cursor-pointer">
                        <option>Chargement...</option>
                    </select>
                    <p class="text-xs text-gray-400 mt-2">üíé = Trading r√©el OK ‚Ä¢ üéÆ = Simulation</p>
                </div>
                
                <div>
                    <label class="block text-sm text-gray-400 mb-2">Mode de Trading</label>
                    <select id="tradingMode" onchange="changeTradingMode()" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-3 focus:outline-none focus:border-yellow-400 text-lg font-semibold cursor-pointer">
                        <option value="simulation">üéÆ Simulation</option>
                        <option value="real">üíé R√©el (PancakeSwap)</option>
                    </select>
                    <p class="text-xs text-gray-400 mt-2" id="modeInfo">‚ö†Ô∏è Activez uniquement si vous comprenez les risques</p>
                </div>
            </div>
        </div>

        <div id="privateKeySection" class="bg-gradient-to-r from-red-500/20 to-orange-500/20 border-2 border-red-500 rounded-xl p-6 mb-6 hidden">
            <h3 class="text-xl font-bold mb-4 flex items-center gap-2">
                <span>üîê</span>
                Trading Automatique 24/7 (Optionnel)
            </h3>
            
            <div class="bg-red-900/30 border border-red-500 rounded-lg p-4 mb-4">
                <p class="text-red-300 font-bold mb-2">‚ö†Ô∏è AVERTISSEMENTS CRITIQUES</p>
                <ul class="text-sm text-red-200 space-y-1">
                    <li>‚Ä¢ Utilisez UNIQUEMENT un wallet d√©di√© avec petit capital</li>
                    <li>‚Ä¢ Votre cl√© priv√©e ne sera JAMAIS sauvegard√©e</li>
                    <li>‚Ä¢ Stock√©e uniquement en m√©moire pendant la session</li>
                    <li>‚Ä¢ Effac√©e automatiquement √† la fermeture de l'onglet</li>
                    <li>‚Ä¢ Laissez vide pour utiliser MetaMask (manuel)</li>
                    <li>‚Ä¢ <strong>MODE 24/7: Gardez l'onglet ouvert et l'√©cran allum√©</strong></li>
                </ul>
            </div>

            <div class="space-y-4">
                <div>
                    <label class="block text-sm text-gray-400 mb-2">Cl√© Priv√©e (pour trading automatique sans confirmation)</label>
                    <input type="password" id="privateKeyInput" placeholder="0x... ou laisser vide pour MetaMask" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-3 focus:outline-none focus:border-red-400">
                    <p class="text-xs text-gray-400 mt-1">
                        <span class="text-yellow-400">‚ö°</span> Vide = Mode manuel (MetaMask) | Rempli = Mode automatique 24/7
                    </p>
                </div>
                
                <button onclick="togglePrivateKeyVisibility()" class="text-sm text-blue-400 hover:underline">
                    üëÅÔ∏è Afficher/Masquer la cl√©
                </button>
            </div>
        </div>

        <div id="capitalSection" class="bg-gradient-to-r from-yellow-400/20 to-orange-500/20 border-2 border-yellow-400 rounded-xl p-6 mb-6 hidden">
            <h3 class="text-xl font-bold mb-4 flex items-center gap-2">
                <span>üéØ</span>
                Capital de trading en USDT
            </h3>
            <p class="text-gray-300 mb-4">
                Montant en USDT pour le trading automatique
                <br />
                <span class="text-sm text-gray-400">Solde disponible: <span id="availableBalance" class="font-bold text-green-400">0</span> USDT</span>
            </p>
            <div class="flex gap-4 mb-3">
                <input type="number" id="capitalInput" placeholder="Ex: 50" step="10" class="flex-1 bg-slate-700 border border-slate-600 rounded-lg px-4 py-3 focus:outline-none focus:border-yellow-400">
                <button onclick="setCapital()" class="px-8 py-3 bg-gradient-to-r from-yellow-400 to-orange-500 hover:from-yellow-500 hover:to-orange-600 rounded-lg font-semibold transition-all">
                    Valider
                </button>
            </div>
            <div class="flex gap-2">
                <button onclick="setMaxCapital()" class="flex-1 px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-sm transition-all">
                    üíØ Utiliser 100%
                </button>
                <button onclick="setHalfCapital()" class="flex-1 px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-sm transition-all">
                    ‚ûó Utiliser 50%
                </button>
                <button onclick="syncWalletBalance()" class="flex-1 px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg text-sm transition-all">
                    üîÑ Actualiser
                </button>
            </div>
        </div>

        <div id="statsCards" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8 hidden">
            <div class="bg-slate-800/50 backdrop-blur-sm border border-slate-700 rounded-xl p-4">
                <p class="text-gray-400 text-xs">Capital</p>
                <p class="text-xl font-bold mt-1 text-green-400">$<span id="capitalDisplay">0</span></p>
            </div>
            
            <div class="bg-slate-800/50 backdrop-blur-sm border border-slate-700 rounded-xl p-4">
                <p class="text-gray-400 text-xs">Prix <span id="cryptoName">BTC</span></p>
                <p class="text-xl font-bold mt-1">$<span id="currentPrice">...</span></p>
            </div>
            
            <div class="bg-slate-800/50 backdrop-blur-sm border border-slate-700 rounded-xl p-4">
                <p class="text-gray-400 text-xs">Profit</p>
                <p class="text-xl font-bold mt-1 text-green-400">$<span id="profitDisplay">0.00</span></p>
            </div>
            
            <div class="bg-slate-800/50 backdrop-blur-sm border border-slate-700 rounded-xl p-4">
                <p class="text-gray-400 text-xs">Mode</p>
                <p class="text-xl font-bold mt-1" id="modeDisplay">üéÆ SIM</p>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="lg:col-span-2 space-y-6">
                <div class="bg-slate-800/50 backdrop-blur-sm border border-slate-700 rounded-xl p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold">üìà Graphique de Trading</h2>
                        <div class="text-sm text-gray-400">
                            <span id="chartCrypto">BTC</span>/USDT
                        </div>
                    </div>
                    <div class="h-64">
                        <canvas id="tradingChart"></canvas>
                    </div>
                </div>

                <div class="bg-slate-800/50 backdrop-blur-sm border border-slate-700 rounded-xl p-6">
                    <h2 class="text-2xl font-bold mb-4">Strat√©gies</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="strategiesGrid"></div>
                </div>

                <div class="bg-slate-800/50 backdrop-blur-sm border border-slate-700 rounded-xl p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold">Historique des Trades</h2>
                        <button onclick="toggleBot()" id="toggleBotBtn" disabled class="flex items-center gap-2 px-6 py-2 rounded-lg font-semibold transition-all bg-gray-600 cursor-not-allowed">
                            <span id="botIcon">‚ñ∂Ô∏è</span>
                            <span id="botText">D√©marrer</span>
                        </button>
                    </div>
                    <div id="tradesContainer">
                        <div class="text-center py-8 text-gray-400">
                            <span class="text-4xl">‚ö†Ô∏è</span>
                            <p>Aucun trade</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="bg-slate-800/50 backdrop-blur-sm border border-slate-700 rounded-xl p-6">
                <h2 class="text-2xl font-bold mb-4">Param√®tres</h2>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">% par trade</label>
                        <input type="number" id="tradePercent" value="10" min="1" max="100" onchange="updateTradeAmount()" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-2 focus:outline-none focus:border-yellow-400">
                        <p class="text-xs text-gray-400 mt-1">Montant: $<span id="tradeAmount">0</span></p>
                    </div>
                    
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">Slippage (%)</label>
                        <input type="number" id="slippage" value="1" step="0.1" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-2 focus:outline-none focus:border-yellow-400">
                        <p class="text-xs text-gray-400 mt-1">‚ö†Ô∏è Recommand√©: 1-2% pour tokens volatils</p>
                    </div>
                </div>

                <div class="mt-6 p-4 bg-green-400/10 border border-green-400/30 rounded-lg">
                    <div class="flex gap-2">
                        <span class="text-green-400">üí∞</span>
                        <div class="text-sm text-gray-300">
                            <p class="font-semibold text-green-400">Soldes</p>
                            <p>BNB: <span id="bnbBalance">0</span></p>
                            <p>USDT: $<span id="usdtBalance">0</span></p>
                        </div>
                    </div>
                </div>

                <div class="mt-4 p-4 bg-blue-400/10 border border-blue-400/30 rounded-lg">
                    <div class="flex gap-2">
                        <span class="text-blue-400">üìä</span>
                        <div class="text-sm text-gray-300">
                            <p class="font-semibold text-blue-400">Statut</p>
                            <p>Wallet: <span id="walletStatus">üî¥ Non connect√©</span></p>
                            <p>Mode: <span id="tradingTypeStatus">üü° ...</span></p>
                            <p>Position: <span id="positionStatus">‚ö™ Aucune</span></p>
                            <p>Binance: <span id="apiStatus">üü° ...</span></p>
                            <p>Ethers: <span id="ethersStatus">üü° ...</span></p>
                        </div>
                    </div>
                </div>

                <div class="mt-4 p-4 bg-red-400/10 border border-red-400/30 rounded-lg">
                    <div class="flex gap-2">
                        <span class="text-red-400">‚ö†Ô∏è</span>
                        <div class="text-xs text-gray-300">
                            <p class="font-semibold text-red-400">ATTENTION</p>
                            <p>‚Ä¢ Risque de perte totale</p>
                            <p>‚Ä¢ Frais gas + slippage</p>
                            <p>‚Ä¢ Minimum 0.01 BNB pour gas</p>
                            <p>‚Ä¢ Commencez petit (10-50$)</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Chat Communautaire -->
    <div id="chatModal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="bg-gradient-to-br from-slate-900 to-slate-800 rounded-2xl shadow-2xl w-full max-w-4xl h-[600px] flex flex-col border-2 border-purple-500/30">
            <!-- Header Chat -->
            <div class="flex justify-between items-center p-6 border-b border-slate-700">
                <div>
                    <h2 class="text-2xl font-bold bg-gradient-to-r from-green-400 to-teal-400 bg-clip-text text-transparent">
                        üí¨ Chat Communautaire Live
                    </h2>
                    <p class="text-sm text-gray-400 mt-1">
                        <span id="onlineCount" class="text-green-400">‚óè</span> 
                        <span id="onlineUsers">...</span> membres en ligne
                    </p>
                </div>
                <button onclick="closeChat()" class="text-gray-400 hover:text-white transition-all text-2xl">‚úï</button>
            </div>

            <!-- Messages Area -->
            <div id="chatMessages" class="flex-1 overflow-y-auto p-6 space-y-4">
                <!-- Messages seront inject√©s ici -->
            </div>

            <!-- Input Area -->
            <div class="p-4 border-t border-slate-700">
                <div class="flex gap-3">
                    <input 
                        type="text" 
                        id="chatInput" 
                        placeholder="Tapez votre message..."
                        class="flex-1 bg-slate-700/50 border border-slate-600 rounded-lg px-4 py-3 focus:outline-none focus:border-green-400 text-white"
                        onkeypress="if(event.key === 'Enter') sendMessage()"
                    >
                    <button onclick="sendMessage()" class="px-6 py-3 bg-gradient-to-r from-green-500 to-teal-600 hover:from-green-600 hover:to-teal-700 rounded-lg font-semibold transition-all">
                        Envoyer üì§
                    </button>
                </div>
                <p class="text-xs text-gray-500 mt-2">
                    üí° Partagez vos strat√©gies et analyses avec la communaut√©
                </p>
            </div>
        </div>
    </div>

    <script>
        const PANCAKE_ROUTER = '0x10ED43C718714eb63d5aA57B78B54704E256024E';
        const USDT_CONTRACT = '0x55d398326f99059fF775485246999027B3197955';
        const BSC_RPC = 'https://bsc-dataseed1.binance.org';
        
        const OWNER_WALLET = '0x5959f13ad996ab184780a778cf6d594786f44250';
        const FREE_WALLET = '0xb44dd82c004a767d23b890f788fd6f9b13fcf6a4';
        const FREE_TRIAL_DAYS = 2;

        let state = {
            account: null, 
            isConnected: false, 
            balanceBNB: '0', 
            balanceUSDT: '0',
            selectedCrypto: 'BTCUSDT', 
            cryptoList: [], 
            currentPrice: null, 
            priceHistory: [],
            tradingCapital: 0, 
            capitalSet: false, 
            tradingMode: 'simulation',
            botRunning: false, 
            trades: [], 
            portfolio: { profit: 0, profitPercent: 0 },
            indicators: { rsi: 50, macd: { histogram: 0 }, ema20: 0, ema50: 0 },
            selectedStrategy: 'scalping', 
            provider: null,
            privateKey: null,
            wallet: null,
            autoMode: false,
            currentPosition: null,
            lastBuyPrice: 0,
            positionAmount: 0,
            lastSellTime: 0,
            lastBuyTime: 0,
            positionSold: false, // Flag pour tracker si la position a √©t√© vendue
            chartData: { labels: [], prices: [], buyPoints: [], sellPoints: [] },
            subscription: {
                isActive: false,
                expiryDate: null,
                firstAccessDate: null,
                selectedPlan: null
            },
            // Nouveaux param√®tres pour la v√©rification de baisse
            priceMonitoring: {
                highestPrice: 0,
                highestPriceTime: 0,
                isDropping: false,
                dropStartTime: 0
            }
        };

        let ws = null, botInterval = null, lastTradeTime = 0;
        let tradingChart = null;
        let wakeLock = null;
        let audioContext = null;
        let positionUpdateInterval = null;
        
        // Variables pour le chat
        let chatMessages = [];
        let chatUsername = '';
        let onlineUsersCount = 0;

        const POST_SELL_COOLDOWN = 120000;
        const MIN_TRADE_INTERVAL = 60000; // 1 minute minimum entre trades
        const PRICE_DROP_WAIT_TIME = 600000; // 10 minutes en millisecondes
        const MIN_DROP_PERCENTAGE = 0.5; // Baisse minimale de 0.5% pour consid√©rer une vraie baisse

        const TOKEN_ADDRESSES = {
            'BTCUSDT': '0x7130d2A12B9BCbFAe4f2634d864A1Ee1Ce3Ead9c',
            'ETHUSDT': '0x2170Ed0880ac9A755fd29B2688956BD959F933F8',
            'BNBUSDT': '0xbb4CdB9CBd36B01bD1cBaEBF2De08d9173bc095c'
        };

        const strategies = {
            scalping: { 
                name: 'Scalping', 
                description: 'Rapide RSI+MACD', 
                minTradeInterval: 180000,
                rsiBuyThreshold: 40,
                rsiBuyStrong: 30,
                rsiSellThreshold: 60,
                rsiSellStrong: 70,
                takeProfit: 1.5,
                stopLoss: -1.0
            },
            swing: { 
                name: 'Swing', 
                description: 'Positions EMA', 
                minTradeInterval: 900000,
                rsiBuyThreshold: 35,
                rsiBuyStrong: 25,
                rsiSellThreshold: 70,
                rsiSellStrong: 75,
                takeProfit: 3.0,
                stopLoss: -2.0
            }
        };

        // Initialization
        window.addEventListener('DOMContentLoaded', () => {
            console.log('üöÄ Bot charg√© - Version OPTIMIS√âE');
            console.log('üíé Trading limit√© √†: BTC, ETH, BNB');
            console.log('‚è±Ô∏è Attente 10 minutes apr√®s baisse d√©tect√©e');
            console.log('üõ°Ô∏è Protection anti-double achat');
            
            if (typeof ethers !== 'undefined') {
                document.getElementById('ethersStatus').innerHTML = 'üü¢ v' + ethers.version;
            } else {
                document.getElementById('ethersStatus').innerHTML = 'üî¥ Erreur';
            }
            
            initChart();
            renderStrategies();
            
            // Auto-connexion si wallet d√©j√† connect√©
            if (window.ethereum && window.ethereum.selectedAddress) {
                connectWallet();
            }
        });

        // Wallet Functions
        async function connectWallet() {
            if (!window.ethereum) {
                alert('‚ùå MetaMask non install√©\n\nVeuillez installer MetaMask pour continuer.');
                return;
            }

            try {
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                const chainId = await window.ethereum.request({ method: 'eth_chainId' });
                
                // V√©rifier si on est sur BSC
                if (chainId !== '0x38') {
                    try {
                        await window.ethereum.request({
                            method: 'wallet_addEthereumChain',
                            params: [{
                                chainId: '0x38',
                                chainName: 'BNB Smart Chain',
                                nativeCurrency: { name: 'BNB', symbol: 'BNB', decimals: 18 },
                                rpcUrls: [BSC_RPC],
                                blockExplorerUrls: ['https://bscscan.com']
                            }]
                        });
                    } catch (switchError) {
                        console.error('Erreur changement r√©seau:', switchError);
                    }
                }
                
                state.account = accounts[0];
                state.provider = new ethers.providers.Web3Provider(window.ethereum);
                state.isConnected = true;
                
                console.log('‚úÖ Wallet connect√©:', state.account);
                
                // Charger les soldes
                try {
                    const bnbBalance = await state.provider.getBalance(state.account);
                    state.balanceBNB = ethers.utils.formatEther(bnbBalance);
                    
                    const usdtContract = new ethers.Contract(
                        USDT_CONTRACT,
                        ['function balanceOf(address) view returns (uint256)'],
                        state.provider
                    );
                    const usdtBalance = await usdtContract.balanceOf(state.account);
                    state.balanceUSDT = ethers.utils.formatUnits(usdtBalance, 18);
                    
                    console.log('üí∞ BNB:', state.balanceBNB);
                    console.log('üíµ USDT:', state.balanceUSDT);
                    
                    // Sugg√©rer le capital disponible
                    if (parseFloat(state.balanceUSDT) > 0) {
                        document.getElementById('capitalInput').value = Math.floor(parseFloat(state.balanceUSDT));
                    }
                } catch (balanceError) {
                    console.error('Erreur lecture soldes:', balanceError);
                }
                
                await checkSubscription();
                updateUI();
                
                // Charger les cryptos SEULEMENT apr√®s connexion wallet
                fetchCryptoList();
                
            } catch (error) {
                console.error('‚ùå Erreur connexion:', error);
                alert('Erreur connexion wallet: ' + error.message);
            }
        }

        function checkSubscription() {
            const walletLower = state.account.toLowerCase();
            
            // Wallet gratuit VIP
            if (walletLower === FREE_WALLET.toLowerCase()) {
                state.subscription.isActive = true;
                state.subscription.expiryDate = new Date(2099, 11, 31);
                console.log('üëë Acc√®s VIP gratuit activ√©');
                return true;
            }
            
            // V√©rifier abonnement payant
            const savedSub = localStorage.getItem(`subscription_${walletLower}`);
            if (savedSub) {
                const subData = JSON.parse(savedSub);
                const expiryDate = new Date(subData.expiryDate);
                const now = new Date();
                
                if (now < expiryDate) {
                    state.subscription.isActive = true;
                    state.subscription.expiryDate = expiryDate;
                    const daysLeft = Math.ceil((expiryDate - now) / (1000 * 60 * 60 * 24));
                    console.log(`‚úÖ Abonnement actif - ${daysLeft} jours restants`);
                    return true;
                }
            }
            
            // V√©rifier p√©riode d'essai gratuite (2 jours)
            const firstAccess = localStorage.getItem(`first_access_${walletLower}`);
            if (!firstAccess) {
                const now = new Date();
                const expiryDate = new Date(now.getTime() + FREE_TRIAL_DAYS * 24 * 60 * 60 * 1000);
                
                localStorage.setItem(`first_access_${walletLower}`, now.toISOString());
                localStorage.setItem(`subscription_${walletLower}`, JSON.stringify({
                    expiryDate: expiryDate.toISOString(),
                    firstAccessDate: now.toISOString(),
                    isTrial: true
                }));
                
                state.subscription.isActive = true;
                state.subscription.expiryDate = expiryDate;
                
                console.log(`üéÅ Essai gratuit ${FREE_TRIAL_DAYS} jours activ√©`);
                
                // Afficher bri√®vement la section abonnement
                document.getElementById('subscriptionSection').classList.remove('hidden');
                document.getElementById('trialDaysRemaining').textContent = 
                    `‚è∞ Essai gratuit: ${FREE_TRIAL_DAYS} jours restants`;
                
                setTimeout(() => {
                    document.getElementById('subscriptionSection').classList.add('hidden');
                }, 4000);
                
                return true;
            } else {
                const firstAccessDate = new Date(firstAccess);
                const now = new Date();
                const trialExpiryDate = new Date(firstAccessDate.getTime() + FREE_TRIAL_DAYS * 24 * 60 * 60 * 1000);
                
                if (now < trialExpiryDate) {
                    const hoursLeft = Math.ceil((trialExpiryDate - now) / (1000 * 60 * 60));
                    const daysLeft = Math.ceil(hoursLeft / 24);
                    
                    state.subscription.isActive = true;
                    state.subscription.expiryDate = trialExpiryDate;
                    
                    console.log(`üéÅ Essai gratuit - ${daysLeft} jours restants`);
                    
                    // Notification
                    document.getElementById('subscriptionSection').classList.remove('hidden');
                    document.getElementById('trialDaysRemaining').textContent = 
                        `‚è∞ Essai gratuit: ${daysLeft} jour${daysLeft > 1 ? 's' : ''} restant${daysLeft > 1 ? 's' : ''}`;
                    
                    setTimeout(() => {
                        document.getElementById('subscriptionSection').classList.add('hidden');
                    }, 3000);
                    
                    return true;
                } else {
                    console.log('‚ùå P√©riode d\'essai expir√©e');
                    document.getElementById('subscriptionSection').classList.remove('hidden');
                    document.getElementById('freeTrialInfo').innerHTML = `
                        <p class="text-red-300 font-bold mb-2">‚è∞ P√âRIODE D'ESSAI EXPIR√âE</p>
                        <p class="text-sm text-red-200">
                            Choisissez un forfait pour continuer.
                        </p>
                    `;
                    document.getElementById('freeTrialInfo').className = 
                        'bg-red-500/20 border border-red-500 rounded-lg p-4 mb-4';
                    
                    state.subscription.isActive = false;
                    return false;
                }
            }
        }

        function selectPlan(days, price) {
            state.subscription.selectedPlan = { days, price };
            document.getElementById('selectedPlanInfo').classList.remove('hidden');
            document.getElementById('planDuration').textContent = days;
            document.getElementById('planPrice').textContent = price;
            document.getElementById('paymentBtn').disabled = false;
            document.getElementById('paymentBtnText').textContent = `Payer ${price} USDT`;
        }

        async function processPayment() {
            alert('Fonction de paiement √† impl√©menter');
        }

        // UI Functions
        function updateUI() {
            if (state.isConnected) {
                document.getElementById('connectBtn').className = 
                    'flex items-center gap-2 px-6 py-3 rounded-lg font-semibold transition-all bg-green-600 hover:bg-green-700';
                document.getElementById('walletText').textContent = 
                    `${state.account.slice(0, 6)}...${state.account.slice(-4)}`;
                document.getElementById('walletStatus').innerHTML = 'üü¢ Connect√©';
                
                // Afficher les sections seulement si abonnement actif
                if (state.subscription.isActive) {
                    document.getElementById('cryptoSelector').classList.remove('hidden');
                    document.getElementById('privateKeySection').classList.remove('hidden');
                    document.getElementById('capitalSection').classList.remove('hidden');
                }
                
                // Mettre √† jour les soldes
                document.getElementById('bnbBalance').textContent = parseFloat(state.balanceBNB).toFixed(4);
                document.getElementById('usdtBalance').textContent = parseFloat(state.balanceUSDT).toFixed(2);
                document.getElementById('availableBalance').textContent = parseFloat(state.balanceUSDT).toFixed(2);
            }
            
            if (state.capitalSet) {
                document.getElementById('capitalSection').classList.add('hidden');
                document.getElementById('statsCards').classList.remove('hidden');
                document.getElementById('capitalDisplay').textContent = state.tradingCapital.toFixed(2);
                updateTradeAmount();
            }
            
            // Mettre √† jour le mode de trading
            if (state.tradingMode === 'real') {
                document.getElementById('modeDisplay').innerHTML = 'üíé R√âEL';
                document.getElementById('modeDisplay').className = 'text-xl font-bold mt-1 text-orange-400';
            } else {
                document.getElementById('modeDisplay').innerHTML = 'üéÆ SIM';
                document.getElementById('modeDisplay').className = 'text-xl font-bold mt-1 text-blue-400';
            }
            
            // Mettre √† jour le type de trading
            if (state.autoMode) {
                document.getElementById('tradingTypeStatus').innerHTML = 'ü§ñ Automatique 24/7';
            } else if (state.isConnected) {
                document.getElementById('tradingTypeStatus').innerHTML = 'üì± Manuel MetaMask';
            } else {
                document.getElementById('tradingTypeStatus').innerHTML = 'üü° Non configur√©';
            }
        }

        function initChart() {
            const ctx = document.getElementById('tradingChart').getContext('2d');
            tradingChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Prix',
                        data: [],
                        borderColor: 'rgb(59, 130, 246)',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
        }

        function renderStrategies() {
            document.getElementById('strategiesGrid').innerHTML = Object.entries(strategies).map(([key, s]) => `
                <div onclick="selectStrategy('${key}')" class="p-4 rounded-lg border-2 ${state.selectedStrategy === key ? 'border-yellow-400 bg-yellow-400/10' : 'border-slate-600'} cursor-pointer">
                    <h3 class="font-bold mb-2">${s.name}</h3>
                    <p class="text-gray-400 text-sm">${s.description}</p>
                </div>
            `).join('');
        }

        function selectStrategy(key) {
            state.selectedStrategy = key;
            renderStrategies();
        }

        // Crypto Functions
        async function fetchCryptoList() {
            document.getElementById('refreshIcon').classList.add('animate-spin');
            document.getElementById('refreshText').textContent = 'Chargement...';
            
            try {
                let data = null;
                
                // M√©thode 1: Essayer avec un proxy CORS
                try {
                    console.log('üì° Tentative via proxy CORS...');
                    const proxyUrl = 'https://api.allorigins.win/raw?url=';
                    const apiUrl = encodeURIComponent('https://api.binance.com/api/v3/ticker/24hr');
                    const response = await fetch(proxyUrl + apiUrl, {
                        method: 'GET',
                        headers: { 'Accept': 'application/json' }
                    });
                    data = await response.json();
                    console.log('‚úÖ Donn√©es r√©cup√©r√©es via proxy');
                } catch (proxyError) {
                    console.log('‚ö†Ô∏è Proxy √©chou√©:', proxyError.message);
                    
                    // M√©thode 2: Essayer directement (peut √©chouer √† cause de CORS)
                    try {
                        console.log('üì° Tentative directe...');
                        const response = await fetch('https://api.binance.com/api/v3/ticker/24hr');
                        data = await response.json();
                        console.log('‚úÖ Donn√©es r√©cup√©r√©es directement');
                    } catch (directError) {
                        console.log('‚ö†Ô∏è API directe √©chou√©e:', directError.message);
                        throw new Error('Impossible de r√©cup√©rer les donn√©es');
                    }
                }
                
                if (!data || !Array.isArray(data)) {
                    throw new Error('Format de donn√©es invalide');
                }
                
                // Traiter les donn√©es re√ßues - FILTRER UNIQUEMENT BTC, ETH, BNB
                const allowedSymbols = ['BTCUSDT', 'ETHUSDT', 'BNBUSDT'];
                const topCryptos = data
                    .filter(item => allowedSymbols.includes(item.symbol))
                    .sort((a, b) => parseFloat(b.volume) - parseFloat(a.volume));
                
                state.cryptoList = topCryptos.map(item => ({
                    symbol: item.symbol,
                    name: item.symbol.replace('USDT', ''),
                    price: parseFloat(item.lastPrice),
                    priceChange: parseFloat(item.priceChangePercent),
                    volume: parseFloat(item.volume),
                    realTradingAvailable: !!TOKEN_ADDRESSES[item.symbol]
                }));
                
                // Trier par ordre: BTC, ETH, BNB
                state.cryptoList.sort((a, b) => {
                    const order = { 'BTCUSDT': 1, 'ETHUSDT': 2, 'BNBUSDT': 3 };
                    return order[a.symbol] - order[b.symbol];
                });
                
                document.getElementById('cryptoSelect').innerHTML = state.cryptoList.map(c => 
                    `<option value="${c.symbol}">${c.name} - ${c.price.toFixed(c.price < 1 ? 6 : 2)} ${c.realTradingAvailable ? 'üíé' : 'üéÆ'}</option>`
                ).join('');
                
                if (state.cryptoList.length > 0) {
                    state.selectedCrypto = state.cryptoList[0].symbol;
                    connectWebSocket();
                }
                
                document.getElementById('cryptoCount').textContent = `(${state.cryptoList.length})`;
                document.getElementById('apiStatus').innerHTML = 'üü¢ En ligne';
                console.log(`‚úÖ ${state.cryptoList.length} cryptos charg√©es`);
                
            } catch (error) {
                console.error('‚ùå Erreur compl√®te:', error);
                
                // Fallback: charger une liste par d√©faut
                console.log('üìã Chargement de la liste par d√©faut...');
                loadDefaultCryptoList();
            } finally {
                document.getElementById('refreshIcon').classList.remove('animate-spin');
                document.getElementById('refreshText').textContent = 'Actualiser';
            }
        }
        
        function loadDefaultCryptoList() {
            // UNIQUEMENT BTC, ETH, BNB
            const defaultCryptos = [
                { symbol: 'BTCUSDT', name: 'BTC', price: 95000, priceChange: 2.5, volume: 50000000000 },
                { symbol: 'ETHUSDT', name: 'ETH', price: 3400, priceChange: 1.8, volume: 20000000000 },
                { symbol: 'BNBUSDT', name: 'BNB', price: 650, priceChange: -0.5, volume: 3000000000 }
            ];
            
            state.cryptoList = defaultCryptos.map(c => ({
                ...c,
                realTradingAvailable: !!TOKEN_ADDRESSES[c.symbol]
            }));
            
            document.getElementById('cryptoSelect').innerHTML = state.cryptoList.map(c => 
                `<option value="${c.symbol}">${c.name} - ${c.price.toFixed(c.price < 1 ? 6 : 2)} ${c.realTradingAvailable ? 'üíé' : 'üéÆ'}</option>`
            ).join('');
            
            if (state.cryptoList.length > 0) {
                state.selectedCrypto = state.cryptoList[0].symbol;
                connectWebSocket();
            }
            
            document.getElementById('cryptoCount').textContent = `(${state.cryptoList.length})`;
            document.getElementById('apiStatus').innerHTML = 'üü° Mode Hors Ligne';
            
            console.log('‚úÖ Liste charg√©e - BTC, ETH, BNB uniquement');
            
            // Afficher un message √† l'utilisateur
            const message = document.createElement('div');
            message.className = 'fixed top-4 right-4 bg-blue-500/20 border border-blue-500 rounded-lg p-4 max-w-md z-50';
            message.innerHTML = `
                <p class="text-blue-300 font-bold mb-2">üíé Trading Limit√©</p>
                <p class="text-sm text-blue-200">
                    Trading disponible pour:<br>
                    ‚Ä¢ BTC (Bitcoin)<br>
                    ‚Ä¢ ETH (Ethereum)<br>
                    ‚Ä¢ BNB (Binance Coin)
                </p>
            `;
            document.body.appendChild(message);
            
            setTimeout(() => message.remove(), 6000);
        }

        function changeCrypto() {
            state.selectedCrypto = document.getElementById('cryptoSelect').value;
            state.priceHistory = [];
            state.currentPosition = null; // Reset position lors du changement
            state.lastBuyTime = 0;
            state.lastSellTime = 0;
            state.positionSold = false; // Reset du flag de vente
            state.positionAmount = 0;
            state.lastBuyPrice = 0;
            // R√©initialiser le monitoring du prix
            state.priceMonitoring = {
                highestPrice: 0,
                highestPriceTime: 0,
                isDropping: false,
                dropStartTime: 0
            };
            document.getElementById('positionStatus').innerHTML = '‚ö™ Aucune';
            console.log(`üîÑ Changement vers ${state.selectedCrypto} - Tous les √©tats r√©initialis√©s`);
            connectWebSocket();
        }

        function changeTradingMode() {
            state.tradingMode = document.getElementById('tradingMode').value;
            updateUI();
        }

        function connectWebSocket() {
            if (ws) {
                ws.close();
                ws = null;
            }
            
            try {
                const symbol = state.selectedCrypto.toLowerCase();
                console.log('üîå Connexion WebSocket:', symbol);
                
                ws = new WebSocket(`wss://stream.binance.com:9443/ws/${symbol}@ticker`);
                
                ws.onopen = () => {
                    console.log('‚úÖ WebSocket connect√©');
                    document.getElementById('apiStatus').innerHTML = 'üü¢ En ligne';
                };
                
                ws.onmessage = (event) => {
                    try {
                        const data = JSON.parse(event.data);
                        state.currentPrice = parseFloat(data.c);
                        
                        state.priceHistory.push(state.currentPrice);
                        if (state.priceHistory.length > 100) state.priceHistory.shift();
                        
                        // Mettre √† jour l'affichage
                        document.getElementById('currentPrice').textContent = state.currentPrice.toFixed(2);
                        document.getElementById('cryptoName').textContent = state.selectedCrypto.replace('USDT', '');
                        
                        // Mettre √† jour le graphique toutes les 5 secondes
                        if (state.priceHistory.length % 5 === 0) {
                            updateChart();
                        }
                    } catch (error) {
                        console.error('Erreur parsing WebSocket:', error);
                    }
                };
                
                ws.onerror = (error) => {
                    console.error('‚ùå WebSocket erreur:', error);
                    document.getElementById('apiStatus').innerHTML = 'üî¥ D√©connect√©';
                };
                
                ws.onclose = () => {
                    console.log('üîå WebSocket ferm√©');
                    document.getElementById('apiStatus').innerHTML = 'üü° D√©connect√©';
                    
                    // Tentative de reconnexion apr√®s 5 secondes
                    setTimeout(() => {
                        if (!ws || ws.readyState === WebSocket.CLOSED) {
                            console.log('üîÑ Tentative de reconnexion...');
                            connectWebSocket();
                        }
                    }, 5000);
                };
            } catch (error) {
                console.error('‚ùå Erreur connexion WebSocket:', error);
                document.getElementById('apiStatus').innerHTML = 'üî¥ Erreur';
            }
        }
        
        function updateChart() {
            if (!tradingChart || state.priceHistory.length === 0) return;
            
            const maxPoints = 50;
            const prices = state.priceHistory.slice(-maxPoints);
            const labels = prices.map((_, i) => {
                const now = new Date();
                const time = new Date(now.getTime() - (maxPoints - i - 1) * 5000);
                return time.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            });
            
            tradingChart.data.labels = labels;
            tradingChart.data.datasets[0].data = prices;
            tradingChart.update('none');
        }

        // Trading Functions
        function togglePrivateKeyVisibility() {
            const input = document.getElementById('privateKeyInput');
            input.type = input.type === 'password' ? 'text' : 'password';
        }

        function setCapital() {
            const capital = parseFloat(document.getElementById('capitalInput').value);
            
            if (!capital || capital <= 0) {
                alert('‚ùå Montant invalide');
                return;
            }
            
            state.tradingCapital = capital;
            state.capitalSet = true;
            
            document.getElementById('capitalSection').classList.add('hidden');
            document.getElementById('statsCards').classList.remove('hidden');
            document.getElementById('capitalDisplay').textContent = capital.toFixed(2);
            document.getElementById('toggleBotBtn').disabled = false;
            document.getElementById('toggleBotBtn').className = 
                'flex items-center gap-2 px-6 py-2 rounded-lg font-semibold transition-all bg-green-600 hover:bg-green-700';
            
            updateTradeAmount();
            alert(`‚úÖ Capital d√©fini: ${capital} USDT`);
        }

        function setMaxCapital() {
            document.getElementById('capitalInput').value = 100;
        }

        function setHalfCapital() {
            document.getElementById('capitalInput').value = 50;
        }

        function syncWalletBalance() {
            alert('Fonction de synchronisation en cours de d√©veloppement');
        }

        function updateTradeAmount() {
            const percent = parseFloat(document.getElementById('tradePercent').value);
            const amount = (state.tradingCapital * percent / 100).toFixed(2);
            document.getElementById('tradeAmount').textContent = amount;
        }

        function toggleBot() {
            if (!state.subscription.isActive) {
                alert('‚ùå Abonnement requis');
                document.getElementById('subscriptionSection').classList.remove('hidden');
                return;
            }
            
            if (!state.capitalSet) {
                alert('‚ùå D√©finissez le capital');
                return;
            }
            
            state.botRunning = !state.botRunning;
            
            if (state.botRunning) {
                startBot();
                alert('‚úÖ Bot d√©marr√© en mode ' + (state.tradingMode === 'real' ? 'R√âEL' : 'SIMULATION') + 
                      '\n\nüõ°Ô∏è Protection anti-double achat active' +
                      '\n‚è±Ô∏è Attente 10 min apr√®s d√©tection baisse' +
                      '\nüíé Trading: BTC, ETH, BNB uniquement');
            } else {
                stopBot();
            }
            
            updateBotButton();
        }

        function updateBotButton() {
            const btn = document.getElementById('toggleBotBtn');
            if (state.botRunning) {
                btn.className = 'flex items-center gap-2 px-6 py-2 rounded-lg font-semibold transition-all bg-red-600 hover:bg-red-700';
                document.getElementById('botIcon').textContent = '‚è∏Ô∏è';
                document.getElementById('botText').textContent = 'Arr√™ter';
            } else {
                btn.className = 'flex items-center gap-2 px-6 py-2 rounded-lg font-semibold transition-all bg-green-600 hover:bg-green-700';
                document.getElementById('botIcon').textContent = '‚ñ∂Ô∏è';
                document.getElementById('botText').textContent = 'D√©marrer';
            }
        }

        function startBot() {
            console.log('üöÄ Bot d√©marr√© - Version avec Baisse 10min + BTC/ETH/BNB uniquement');
            console.log('üõ°Ô∏è Protection anti-double achat ACTIVE');
            console.log('‚è±Ô∏è Attente 10 minutes apr√®s d√©tection de baisse');
            
            // R√©initialiser le monitoring au d√©marrage
            state.priceMonitoring = {
                highestPrice: state.currentPrice || 0,
                highestPriceTime: Date.now(),
                isDropping: false,
                dropStartTime: 0
            };
            
            botInterval = setInterval(() => {
                if (state.priceHistory.length < 20) {
                    console.log('‚è≥ Collecte des donn√©es...');
                    return;
                }
                
                const signal = getTradeSignal();
                if (signal.signal) {
                    executeTrade(signal.signal);
                }
            }, 10000); // Check every 10 seconds
        }

        function stopBot() {
            if (botInterval) {
                clearInterval(botInterval);
                botInterval = null;
                console.log('üõë Bot arr√™t√©');
            }
        }

        function updatePriceMonitoring(currentPrice) {
            const now = Date.now();
            const monitoring = state.priceMonitoring;
            
            // Mettre √† jour le prix le plus haut
            if (currentPrice > monitoring.highestPrice || monitoring.highestPrice === 0) {
                monitoring.highestPrice = currentPrice;
                monitoring.highestPriceTime = now;
                monitoring.isDropping = false;
                monitoring.dropStartTime = 0;
                console.log(`üìà Nouveau prix maximum: ${currentPrice.toFixed(2)}`);
                return;
            }
            
            // Calculer la baisse en pourcentage depuis le plus haut
            const dropPercent = ((monitoring.highestPrice - currentPrice) / monitoring.highestPrice) * 100;
            
            // D√©tecter le d√©but d'une baisse
            if (dropPercent >= MIN_DROP_PERCENTAGE && !monitoring.isDropping) {
                monitoring.isDropping = true;
                monitoring.dropStartTime = now;
                console.log(`üìâ Baisse d√©tect√©e: ${dropPercent.toFixed(2)}% depuis ${monitoring.highestPrice.toFixed(2)}`);
            }
            
            // Si le prix remonte, r√©initialiser
            if (monitoring.isDropping && currentPrice > monitoring.highestPrice * 0.995) {
                console.log(`üìà Prix en remont√©e, r√©initialisation du monitoring`);
                monitoring.highestPrice = currentPrice;
                monitoring.highestPriceTime = now;
                monitoring.isDropping = false;
                monitoring.dropStartTime = 0;
            }
        }
        
        function canBuyAfterDrop() {
            const monitoring = state.priceMonitoring;
            const now = Date.now();
            
            // Si pas de baisse en cours, pas d'achat
            if (!monitoring.isDropping) {
                return { canBuy: false, reason: 'Prix stable ou en hausse', waitTime: 0 };
            }
            
            // Calculer le temps √©coul√© depuis le d√©but de la baisse
            const timeElapsed = now - monitoring.dropStartTime;
            
            // Calculer la baisse actuelle
            const dropPercent = ((monitoring.highestPrice - state.currentPrice) / monitoring.highestPrice) * 100;
            
            // Si 10 minutes se sont √©coul√©es et le prix est toujours en baisse
            if (timeElapsed >= PRICE_DROP_WAIT_TIME) {
                return { 
                    canBuy: true, 
                    reason: `Baisse confirm√©e de ${dropPercent.toFixed(2)}% depuis ${Math.floor(timeElapsed / 60000)} minutes`,
                    waitTime: 0
                };
            }
            
            // Sinon, il faut attendre
            const remainingTime = PRICE_DROP_WAIT_TIME - timeElapsed;
            const remainingMinutes = Math.ceil(remainingTime / 60000);
            
            return { 
                canBuy: false, 
                reason: `Baisse de ${dropPercent.toFixed(2)}% d√©tect√©e, attente ${remainingMinutes} min avant achat`,
                waitTime: remainingTime
            };
        }
        
        function getTradeSignal() {
            const rsi = calculateRSI(state.priceHistory);
            const strategy = strategies[state.selectedStrategy];
            const now = Date.now();
            
            // Mettre √† jour le monitoring du prix
            if (state.currentPrice) {
                updatePriceMonitoring(state.currentPrice);
            }
            
            // PROTECTION: V√©rifier qu'on n'a pas d√©j√† une position ouverte
            if (state.currentPosition === 'BUY') {
                console.log(`üìä Position LONG ouverte - RSI: ${rsi.toFixed(2)} - En attente de signal VENTE`);
                
                // VENTE: Seulement si position ouverte ET RSI √©lev√© ET pas encore vendue
                if (rsi > strategy.rsiSellThreshold) {
                    // V√©rifier si la position a d√©j√† √©t√© vendue
                    if (state.positionSold) {
                        console.log(`üîí Position d√©j√† vendue - En attente de nouveau cycle`);
                        return { signal: null, confidence: 0 };
                    }
                    
                    // V√©rifier le d√©lai minimum depuis le dernier achat
                    const timeSinceBuy = now - state.lastBuyTime;
                    if (timeSinceBuy < MIN_TRADE_INTERVAL) {
                        console.log(`‚è±Ô∏è D√©lai minimum non respect√© (${Math.ceil((MIN_TRADE_INTERVAL - timeSinceBuy) / 1000)}s restantes)`);
                        return { signal: null, confidence: 0 };
                    }
                    
                    // V√âRIFICATION SUPPL√âMENTAIRE: S'assurer qu'on a bien une position
                    if (state.positionAmount <= 0) {
                        console.error('üö´ ERREUR: Position amount = 0, impossible de vendre');
                        state.currentPosition = null; // Reset en cas d'incoh√©rence
                        state.positionSold = false;
                        return { signal: null, confidence: 0 };
                    }
                    
                    console.log(`üî¥ Signal VENTE d√©tect√© - RSI: ${rsi.toFixed(2)} - Position: ${state.positionAmount} USDT`);
                    return { signal: 'SELL', confidence: 0.8 };
                }
            } else if (state.currentPosition === null) {
                // ACHAT: Seulement si AUCUNE position ouverte
                if (rsi < strategy.rsiBuyThreshold) {
                    // V√©rifier le d√©lai minimum depuis la derni√®re vente
                    const timeSinceSell = now - state.lastSellTime;
                    if (timeSinceSell < MIN_TRADE_INTERVAL && state.lastSellTime > 0) {
                        console.log(`‚è±Ô∏è D√©lai minimum apr√®s vente (${Math.ceil((MIN_TRADE_INTERVAL - timeSinceSell) / 1000)}s restantes)`);
                        return { signal: null, confidence: 0 };
                    }
                    
                    // NOUVELLE V√âRIFICATION: Le prix doit √™tre en baisse depuis 10 minutes
                    const dropCheck = canBuyAfterDrop();
                    if (!dropCheck.canBuy) {
                        console.log(`‚è≥ ${dropCheck.reason}`);
                        return { signal: null, confidence: 0 };
                    }
                    
                    console.log(`üü¢ Signal ACHAT valid√© - RSI: ${rsi.toFixed(2)} - ${dropCheck.reason}`);
                    return { signal: 'BUY', confidence: 0.8 };
                }
            } else {
                // √âtat incoh√©rent d√©tect√©
                console.error(`‚ö†Ô∏è √âTAT INCOH√âRENT: currentPosition = ${state.currentPosition}`);
                state.currentPosition = null;
                state.positionAmount = 0;
                state.positionSold = false;
            }
            
            return { signal: null, confidence: 0 };
        }

        function calculateRSI(prices, period = 14) {
            if (prices.length < period + 1) return 50;
            
            let gains = 0, losses = 0;
            for (let i = prices.length - period; i < prices.length; i++) {
                const change = prices[i] - prices[i - 1];
                if (change > 0) gains += change;
                else losses += Math.abs(change);
            }
            
            const avgGain = gains / period;
            const avgLoss = losses / period;
            if (avgLoss === 0) return 100;
            
            const rs = avgGain / avgLoss;
            return 100 - (100 / (1 + rs));
        }

        function executeTrade(tradeType) {
            const percent = parseFloat(document.getElementById('tradePercent').value);
            const amount = (state.tradingCapital * percent / 100).toFixed(2);
            const now = Date.now();
            
            // PROTECTION FINALE: Double v√©rification avant ex√©cution
            if (tradeType === 'BUY' && state.currentPosition === 'BUY') {
                console.error('üö´ BLOQU√â: Tentative d\'achat alors qu\'une position est d√©j√† ouverte!');
                return;
            }
            
            if (tradeType === 'SELL') {
                // V√©rifications multiples pour la vente
                if (state.currentPosition !== 'BUY') {
                    console.error('üö´ BLOQU√â: Tentative de vente sans position ouverte!');
                    return;
                }
                
                if (state.positionSold) {
                    console.error('üö´ BLOQU√â: Cette position a d√©j√† √©t√© vendue!');
                    return;
                }
                
                if (state.positionAmount <= 0) {
                    console.error('üö´ BLOQU√â: Montant de position invalide!');
                    return;
                }
            }
            
            console.log(`üìä ${tradeType} ex√©cut√© - ${amount} USDT`);
            
            let profit = 0;
            let profitPercent = 0;
            
            if (tradeType === 'BUY') {
                state.currentPosition = 'BUY';
                state.lastBuyPrice = state.currentPrice;
                state.positionAmount = parseFloat(amount);
                state.lastBuyTime = now;
                state.positionSold = false; // Reset du flag √† l'achat
                document.getElementById('positionStatus').innerHTML = 'üü¢ Long';
                console.log(`‚úÖ ACHAT confirm√© - Prix: ${state.currentPrice} - Position ouverte - Flag vente: ${state.positionSold}`);
                
            } else if (tradeType === 'SELL') {
                profitPercent = ((state.currentPrice - state.lastBuyPrice) / state.lastBuyPrice) * 100;
                profit = state.positionAmount * (profitPercent / 100);
                state.portfolio.profit += profit;
                
                // IMPORTANT: Fermer la position et marquer comme vendue
                state.currentPosition = null;
                state.lastSellTime = now;
                state.positionSold = true; // Marquer la position comme vendue
                const soldAmount = state.positionAmount;
                state.positionAmount = 0;
                state.lastBuyPrice = 0;
                
                document.getElementById('positionStatus').innerHTML = '‚ö™ Aucune';
                console.log(`‚úÖ VENTE confirm√©e - Montant: ${soldAmount} USDT - Profit: ${profit.toFixed(2)} USDT (${profitPercent.toFixed(2)}%)`);
                console.log(`üîí Position FERM√âE - Flag vente: ${state.positionSold} - Nouvelle vente impossible jusqu'au prochain achat`);
            }
            
            const trade = {
                id: Date.now(),
                time: new Date().toLocaleTimeString('fr-FR'),
                type: tradeType,
                pair: state.selectedCrypto,
                amount: amount,
                entryPrice: state.currentPrice.toFixed(6),
                profit: profit.toFixed(2),
                profitPercent: profitPercent.toFixed(2),
                mode: state.tradingMode
            };
            
            state.trades.unshift(trade);
            state.trades = state.trades.slice(0, 50);
            
            renderTrades();
            updateUI();
        }

        function renderTrades() {
            if (state.trades.length === 0) return;
            
            document.getElementById('tradesContainer').innerHTML = state.trades.map(t => `
                <div class="flex items-center justify-between p-4 bg-slate-700/50 rounded-lg mb-2 border-l-4 ${t.type === 'BUY' ? 'border-green-400' : 'border-red-400'}">
                    <div class="flex items-center gap-4">
                        <span class="${t.type === 'BUY' ? 'text-green-400' : 'text-red-400'} text-3xl">
                            ${t.type === 'BUY' ? 'üü¢' : 'üî¥'}
                        </span>
                        <div>
                            <p class="font-bold">${t.type} ${t.pair}</p>
                            <p class="text-xs text-gray-400">${t.time} ‚Ä¢ ${t.amount} USDT</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <p class="font-mono">${t.entryPrice}</p>
                        ${t.type === 'SELL' ? `
                            <p class="font-bold ${parseFloat(t.profit) >= 0 ? 'text-green-400' : 'text-red-400'}">
                                ${parseFloat(t.profit) >= 0 ? '+' : ''}${t.profit} USDT
                            </p>
                        ` : ''}
                    </div>
                </div>
            `).join('');
            
            document.getElementById('profitDisplay').textContent = state.portfolio.profit.toFixed(2);
        }

        function openDCASwap() {
            window.open('https://reboot-20.vercel.app/', '_blank');
        }

        // ============================================
        // FONCTIONS CHAT COMMUNAUTAIRE
        // ============================================

        function openChat() {
            document.getElementById('chatModal').classList.remove('hidden');
            
            // G√©n√©rer un username si pas d√©j√† fait
            if (!chatUsername) {
                if (state.account) {
                    chatUsername = state.account.slice(0, 6) + '...' + state.account.slice(-4);
                } else {
                    chatUsername = 'Trader' + Math.floor(Math.random() * 9999);
                }
            }
            
            // Simuler le nombre d'utilisateurs en ligne
            simulateOnlineUsers();
            
            // Charger les messages de la session
            loadChatMessages();
            
            // Simulation d'activit√© du chat
            startChatSimulation();
        }

        function closeChat() {
            document.getElementById('chatModal').classList.add('hidden');
        }

        function simulateOnlineUsers() {
            // Simulation r√©aliste d'utilisateurs en ligne
            onlineUsersCount = Math.floor(Math.random() * 50) + 20; // Entre 20 et 70 users
            document.getElementById('onlineUsers').textContent = onlineUsersCount;
            
            // Variation du nombre d'utilisateurs
            setInterval(() => {
                const change = Math.floor(Math.random() * 5) - 2; // +/- 2 users
                onlineUsersCount = Math.max(15, onlineUsersCount + change);
                document.getElementById('onlineUsers').textContent = onlineUsersCount;
            }, 30000); // Toutes les 30 secondes
        }

        function loadChatMessages() {
            // Charger les messages sauvegard√©s
            const savedMessages = localStorage.getItem('chatMessages');
            if (savedMessages) {
                chatMessages = JSON.parse(savedMessages);
            } else {
                // Messages de bienvenue par d√©faut
                chatMessages = [
                    {
                        username: 'Admin',
                        message: 'üëã Bienvenue sur le chat communautaire !',
                        timestamp: Date.now() - 3600000,
                        type: 'system'
                    },
                    {
                        username: 'CryptoKing',
                        message: 'BTC en train de casser la r√©sistance des 95k !',
                        timestamp: Date.now() - 1800000,
                        type: 'user'
                    },
                    {
                        username: 'ETHTrader',
                        message: 'J\'ai setup un bot sur ETH avec RSI < 30, super r√©sultats',
                        timestamp: Date.now() - 900000,
                        type: 'user'
                    },
                    {
                        username: 'BNBWhale',
                        message: 'Qui trade BNB ici ? Strat√©gie scalping fonctionne bien',
                        timestamp: Date.now() - 300000,
                        type: 'user'
                    }
                ];
            }
            
            renderChatMessages();
        }

        function renderChatMessages() {
            const container = document.getElementById('chatMessages');
            
            container.innerHTML = chatMessages.map(msg => {
                const time = new Date(msg.timestamp).toLocaleTimeString('fr-FR', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
                
                if (msg.type === 'system') {
                    return `
                        <div class="flex justify-center">
                            <div class="bg-blue-500/20 border border-blue-500/30 rounded-lg px-4 py-2 text-sm text-blue-300">
                                ${msg.message}
                            </div>
                        </div>
                    `;
                }
                
                const isOwnMessage = msg.username === chatUsername;
                
                return `
                    <div class="flex ${isOwnMessage ? 'justify-end' : 'justify-start'}">
                        <div class="max-w-[70%]">
                            <div class="flex items-center gap-2 mb-1">
                                ${!isOwnMessage ? `
                                    <span class="text-xs font-semibold ${getUserColor(msg.username)}">${msg.username}</span>
                                ` : ''}
                                <span class="text-xs text-gray-500">${time}</span>
                            </div>
                            <div class="${isOwnMessage ? 
                                'bg-gradient-to-r from-green-600 to-teal-600' : 
                                'bg-slate-700/50'
                            } rounded-lg px-4 py-2">
                                <p class="text-sm text-white">${escapeHtml(msg.message)}</p>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            // Scroll vers le bas
            container.scrollTop = container.scrollHeight;
        }

        function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            // Ajouter le message
            const newMessage = {
                username: chatUsername,
                message: message,
                timestamp: Date.now(),
                type: 'user'
            };
            
            chatMessages.push(newMessage);
            
            // Garder seulement les 100 derniers messages
            if (chatMessages.length > 100) {
                chatMessages = chatMessages.slice(-100);
            }
            
            // Sauvegarder dans localStorage
            localStorage.setItem('chatMessages', JSON.stringify(chatMessages));
            
            // Afficher
            renderChatMessages();
            
            // Clear input
            input.value = '';
            
            // Animation d'envoi
            input.placeholder = 'Message envoy√© ! ‚úì';
            setTimeout(() => {
                input.placeholder = 'Tapez votre message...';
            }, 2000);
        }

        function startChatSimulation() {
            // Simuler des messages de la communaut√©
            const simulatedMessages = [
                { user: 'AlphaTrader', msg: 'Signal haussier sur BTC, MACD en croix dor√©e !' },
                { user: 'CryptoNinja', msg: 'Volume en hausse sur ETH, attention aux breakouts' },
                { user: 'MoonBoy', msg: 'Qui utilise la strat√©gie swing ? R√©sultats ?' },
                { user: 'DiamondHands', msg: 'HODL BTC, le bull run commence üöÄ' },
                { user: 'TechAnalyst', msg: 'RSI en survente sur BNB, opportunit√© d\'achat' },
                { user: 'WhaleWatcher', msg: 'Gros transfert de BTC d√©tect√© sur la blockchain' },
                { user: 'DayTrader', msg: 'Profit de +2.5% sur ETH aujourd\'hui avec le bot' },
                { user: 'CryptoGuru', msg: 'Attention √† la volatilit√©, utilisez des stop loss' },
                { user: 'BTCMaxi', msg: 'BTC > tout le reste, changez mon avis' },
                { user: 'AltCoinKing', msg: 'Les alts vont exploser apr√®s BTC' }
            ];
            
            // Envoyer un message simul√© toutes les 15-45 secondes
            setInterval(() => {
                if (document.getElementById('chatModal').classList.contains('hidden')) return;
                
                const random = simulatedMessages[Math.floor(Math.random() * simulatedMessages.length)];
                
                const simulatedMsg = {
                    username: random.user,
                    message: random.msg,
                    timestamp: Date.now(),
                    type: 'user'
                };
                
                chatMessages.push(simulatedMsg);
                
                if (chatMessages.length > 100) {
                    chatMessages = chatMessages.slice(-100);
                }
                
                localStorage.setItem('chatMessages', JSON.stringify(chatMessages));
                renderChatMessages();
                
            }, Math.random() * 30000 + 15000); // Entre 15 et 45 secondes
        }

        function getUserColor(username) {
            const colors = [
                'text-blue-400',
                'text-green-400',
                'text-yellow-400',
                'text-purple-400',
                'text-pink-400',
                'text-orange-400',
                'text-teal-400',
                'text-cyan-400'
            ];
            
            // Hash simple du username pour couleur consistante
            let hash = 0;
            for (let i = 0; i < username.length; i++) {
                hash = username.charCodeAt(i) + ((hash << 5) - hash);
            }
            
            return colors[Math.abs(hash) % colors.length];
        }

        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, m => map[m]);
        }
    </script>
</body>
</html>
